<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Breezyfy ‚Äî AI Image Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#080810;--surf:#0c0c1c;--card:#101020;--card2:#14142a;
      --bdr:rgba(255,255,255,0.08);--bact:rgba(110,80,255,0.5);
      --acc:#6e50ff;--alit:#9b7dff;--wh:#ffffff;--txt:#e4e4f0;
      --sub:#8888aa;--mut:#4a4a66;--ok:#34d399;--err:#f87171;--r:10px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{background:var(--bg);color:var(--txt);font-family:'Syne',sans-serif}
    body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E");background-size:160px}
    .orb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0}
    .o1{width:500px;height:500px;top:-160px;left:-80px;background:radial-gradient(circle,rgba(110,80,255,.1),transparent 70%)}
    .o2{width:380px;height:380px;bottom:-60px;right:80px;background:radial-gradient(circle,rgba(90,50,200,.07),transparent 70%)}

    header{position:relative;z-index:30;height:52px;flex-shrink:0;display:flex;align-items:center;padding:0 24px;gap:16px;border-bottom:1px solid var(--bdr);background:rgba(8,8,16,.96);backdrop-filter:blur(24px)}
    .logo{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-.02em;color:var(--wh);text-decoration:none;white-space:nowrap;flex-shrink:0}
    .logo span{color:var(--acc)}
    .hd{width:1px;height:20px;background:var(--bdr);flex-shrink:0}
    .htag{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--sub);white-space:nowrap}
    .clear-btn{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--err);background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:7px 14px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all .2s;flex-shrink:0}
    .clear-btn:hover{background:rgba(248,113,113,.18);border-color:rgba(248,113,113,.5)}

    .shell{display:flex;height:calc(100vh - 52px);position:relative;z-index:10}
    .sidebar{width:480px;min-width:460px;flex-shrink:0;height:100%;overflow-y:auto;overflow-x:hidden;background:var(--surf);border-right:1px solid var(--bdr);display:flex;flex-direction:column}
    .sidebar::-webkit-scrollbar{width:4px}
    .sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
    .sec{padding:20px 24px;border-bottom:1px solid var(--bdr)}
    .slbl{font-size:12px;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--wh);margin-bottom:12px;display:flex;align-items:center;gap:10px}
    .slbl::after{content:'';flex:1;height:1px;background:var(--bdr)}
    .pw{position:relative}
    #prompt{width:100%;background:var(--card);border:1px solid var(--bdr);color:var(--wh);padding:13px 15px 32px;border-radius:12px;font-family:'DM Mono',monospace;font-size:13px;line-height:1.75;resize:none;height:130px;outline:none;transition:border-color .2s,box-shadow .2s}
    #prompt::placeholder{color:var(--mut)}
    #prompt:focus{border-color:var(--bact);box-shadow:0 0 0 3px rgba(110,80,255,.09)}
    .cc{position:absolute;bottom:9px;right:12px;font-family:'DM Mono',monospace;font-size:9.5px;color:var(--mut)}
    /* Magic prompt button */
    .magic-btn{
      position:absolute;top:10px;right:10px;
      width:28px;height:28px;border-radius:8px;
      background:rgba(110,80,255,.15);
      border:1px solid rgba(110,80,255,.3);
      color:var(--alit);font-size:14px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:all .2s;z-index:2;
      user-select:none;
    }
    .magic-btn:hover{background:rgba(110,80,255,.35);border-color:var(--acc);transform:scale(1.1)}
    .magic-btn.spin{animation:magicSpin .4s ease}
    @keyframes magicSpin{0%{transform:scale(1) rotate(0)}50%{transform:scale(1.2) rotate(180deg)}100%{transform:scale(1) rotate(360deg)}}
    #neg{width:100%;background:var(--card);border:1px solid var(--bdr);color:var(--sub);padding:11px 14px;border-radius:12px;font-family:'DM Mono',monospace;font-size:11px;line-height:1.65;resize:none;height:76px;outline:none;transition:border-color .2s}
    #neg:focus{border-color:rgba(248,113,113,.3);color:var(--wh)}
    .stabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
    .stab{font-family:'Syne',sans-serif;font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:7px 15px;border-radius:50px;border:1px solid var(--bdr);background:transparent;color:var(--sub);cursor:pointer;transition:all .18s}
    .stab:hover{color:var(--wh);border-color:rgba(255,255,255,.2)}
    .stab.on{background:rgba(110,80,255,.17);border-color:var(--bact);color:var(--wh)}
    input[type="radio"][name="sz"]{display:none}
    .sgrp,.sgrp4{display:none}
    .sgrp.on{display:grid;grid-template-columns:repeat(3,1fr);gap:9px}
    .sgrp4.on{display:grid;grid-template-columns:repeat(4,1fr);gap:9px}
    .scard{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:13px 7px 11px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all .18s}
    .scard:hover{border-color:rgba(110,80,255,.3);background:var(--card2)}
    input[type="radio"]:checked + .scard{border-color:var(--acc);background:rgba(110,80,255,.11)}
    .svis{width:42px;height:32px;display:flex;align-items:center;justify-content:center}
    .srect{background:linear-gradient(135deg,rgba(110,80,255,.38),rgba(155,125,255,.16));border:1.5px solid rgba(110,80,255,.48);border-radius:3px;transition:all .18s}
    input[type="radio"]:checked + .scard .srect{background:linear-gradient(135deg,rgba(110,80,255,.68),rgba(155,125,255,.38));border-color:var(--alit)}
    .srat{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--wh)}
    .spx{font-family:'DM Mono',monospace;font-size:9px;color:var(--sub)}
    input[type="radio"]:checked + .scard .srat{color:var(--alit)}
    .cgrp{display:none;flex-direction:column;gap:10px}
    .cgrp.on{display:flex}
    .crow{display:grid;grid-template-columns:1fr 36px 1fr 36px;gap:8px;align-items:center}
    .diw{position:relative}
    .dilbl{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--sub);pointer-events:none;font-weight:600}
    .diin{width:100%;background:var(--card);border:1px solid var(--bdr);border-radius:9px;color:var(--wh);font-family:'DM Mono',monospace;font-size:14px;padding:10px 9px 10px 26px;outline:none;transition:border-color .2s;-moz-appearance:textfield}
    .diin::-webkit-outer-spin-button,.diin::-webkit-inner-spin-button{-webkit-appearance:none}
    .diin:focus{border-color:var(--bact)}
    .ibtn{background:var(--card);border:1px solid var(--bdr);border-radius:9px;width:36px;height:42px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--sub);font-size:14px;transition:all .18s}
    .ibtn:hover{border-color:var(--bact);color:var(--alit)}
    .ibtn.lk{border-color:var(--bact);color:var(--alit)}
    .appbtn{background:transparent;border:1px dashed rgba(255,255,255,.13);border-radius:9px;color:var(--sub);font-family:'Syne',sans-serif;font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:9px;cursor:pointer;transition:all .18s;width:100%}
    .appbtn:hover{border-color:var(--bact);color:var(--wh)}
    .appbtn.done{border-color:var(--acc);color:var(--alit);background:rgba(110,80,255,.08)}
    .ad-slot{padding:16px 24px 0;display:flex;flex-direction:column;align-items:center;gap:8px;border-top:1px solid var(--bdr)}
    .ad-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--mut);align-self:flex-start}
    .ad-box{width:300px;height:250px;overflow:hidden;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#0c0c1c;flex-shrink:0}
    .gsec{padding:16px 24px 20px;margin-top:auto}
    #genBtn{width:100%;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--acc),#4a30c8);border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;letter-spacing:.06em;padding:16px;cursor:pointer;transition:transform .2s,box-shadow .2s,opacity .2s}
    #genBtn::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.08),transparent)}
    #genBtn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 30px rgba(110,80,255,.42)}
    #genBtn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
    .shim{position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.13),transparent);animation:shim 2.8s infinite}
    @keyframes shim{to{left:200%}}

    .feed-col{flex:1;min-width:0;height:100%;display:flex;flex-direction:column;border-right:1px solid var(--bdr);overflow:hidden}
    .feed-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;text-align:center;padding:40px}
    .fe-ico{width:72px;height:72px;border:1px solid var(--bdr);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:28px;background:var(--card)}
    .fe-title{font-size:22px;font-weight:300;font-family:'DM Mono',monospace;color:var(--wh);letter-spacing:.03em}
    .fe-sub{font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);line-height:1.8}
    .feed-scroll{flex:1;overflow-y:auto;overflow-x:hidden;display:none;flex-direction:column}
    .feed-scroll::-webkit-scrollbar{width:5px}
    .feed-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
    .batch{border-bottom:1px solid var(--bdr);padding:0}
    .bh{display:flex;align-items:center;gap:10px;padding:14px 20px 12px}
    .bh-img-ico{width:22px;height:22px;flex-shrink:0;opacity:.5}
    .bh-divider{width:1px;height:16px;background:var(--bdr);flex-shrink:0}
    .bh-badge{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:.06em;background:var(--card2);border:1px solid var(--bdr);color:var(--sub);padding:3px 10px;border-radius:5px;white-space:nowrap;flex-shrink:0}
    .bh-badge.hi{background:rgba(110,80,255,.12);border-color:rgba(110,80,255,.3);color:var(--alit)}
    .bh-prompt{font-family:'DM Mono',monospace;font-size:12px;color:var(--sub);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bh-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:auto}
    .bh-dl{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--ok);background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.22);padding:5px 14px;border-radius:7px;cursor:pointer;text-decoration:none;transition:all .18s}
    .bh-dl:hover{background:rgba(52,211,153,.16)}
    .batch-img-area{padding:0 20px 20px}
    /* Image + Ad side by side */
    .batch-img-row{display:flex;gap:16px;align-items:flex-start;width:100%}
    .batch-img-col{flex-shrink:0;display:flex;flex-direction:column;gap:10px}
    .batch-ad-col{
      flex:1;min-width:0;
      display:flex;flex-direction:column;gap:12px;
      align-items:center;justify-content:flex-start;
    }
    .ad-unit-wrap{
      width:100%;display:flex;justify-content:center;align-items:flex-start;
      overflow:hidden;border-radius:8px;
    }

    /* ‚ïê‚ïê LOAD CARD ‚ïê‚ïê */
    .load-card{width:100%;border-radius:16px;border:1px solid rgba(110,80,255,.15);background:linear-gradient(135deg,#07071a,#0a0820);overflow:hidden;position:relative;min-height:320px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0}
    .load-grid{position:absolute;inset:0;z-index:0;background-image:linear-gradient(rgba(110,80,255,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(110,80,255,.06) 1px,transparent 1px);background-size:40px 40px;animation:gridPan 8s linear infinite}
    @keyframes gridPan{from{background-position:0 0}to{background-position:40px 40px}}
    .load-glow{position:absolute;inset:0;z-index:0;background:radial-gradient(ellipse 60% 50% at 50% 50%,rgba(110,80,255,.12),transparent 70%);animation:glowPulse 3s ease-in-out infinite}
    @keyframes glowPulse{0%,100%{opacity:.6}50%{opacity:1}}
    .queue-badge{position:relative;z-index:2;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:rgba(155,125,255,.7);background:rgba(110,80,255,.1);border:1px solid rgba(110,80,255,.2);padding:5px 16px;border-radius:50px;margin-bottom:28px;transition:all .4s ease}
    .orb-wrap{position:relative;z-index:2;width:140px;height:140px;display:flex;align-items:center;justify-content:center}
    .ring-outer{position:absolute;inset:0;border-radius:50%;border:1px solid rgba(110,80,255,.2);animation:ringRotate 8s linear infinite}
    .ring-outer::before{content:'';position:absolute;top:-3px;left:50%;width:6px;height:6px;border-radius:50%;background:var(--alit);box-shadow:0 0 10px var(--alit);transform:translateX(-50%)}
    @keyframes ringRotate{to{transform:rotate(360deg)}}
    .ring-mid{position:absolute;inset:14px;border-radius:50%;border:1px solid rgba(110,80,255,.15);animation:ringRotate 5s linear infinite reverse}
    .ring-mid::before{content:'';position:absolute;bottom:-3px;left:50%;width:5px;height:5px;border-radius:50%;background:rgba(110,80,255,.8);box-shadow:0 0 8px rgba(110,80,255,.8);transform:translateX(-50%)}
    .progress-ring{position:absolute;inset:0;transform:rotate(-90deg);opacity:0;transition:opacity .5s ease}
    .progress-ring.visible{opacity:1}
    .progress-ring circle.track{fill:none;stroke:rgba(110,80,255,.1);stroke-width:3}
    .progress-ring circle.fill{fill:none;stroke:url(#progGrad);stroke-width:3;stroke-linecap:round;stroke-dasharray:376;stroke-dashoffset:376;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1)}
    .orb-inner{width:80px;height:80px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(155,125,255,.3),rgba(110,80,255,.1) 50%,transparent);border:1px solid rgba(110,80,255,.3);display:flex;align-items:center;justify-content:center;animation:orbFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(110,80,255,.15),inset 0 0 20px rgba(110,80,255,.05)}
    @keyframes orbFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-6px) scale(1.03)}}
    .pct-text{font-family:'DM Mono',monospace;font-size:18px;font-weight:400;color:var(--wh);letter-spacing:-.02em;opacity:0;transition:opacity .4s ease;text-align:center;line-height:1}
    .pct-text.visible{opacity:1}
    .pct-sub{font-size:8px;letter-spacing:.1em;color:var(--sub);display:block;margin-top:2px}
    .particles{position:absolute;inset:0;z-index:1;pointer-events:none}
    .particle{position:absolute;border-radius:50%;background:rgba(110,80,255,.6);animation:particleDrift var(--dur) ease-in-out infinite;animation-delay:var(--del)}
    @keyframes particleDrift{0%{transform:translate(0,0) scale(1);opacity:0}20%{opacity:1}80%{opacity:.5}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
    .load-status{position:relative;z-index:2;margin-top:24px;text-align:center}
    .load-lbl{font-family:'DM Mono',monospace;font-size:12px;color:var(--sub);letter-spacing:.08em;transition:all .3s ease}
    .load-sublbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--mut);letter-spacing:.05em;margin-top:6px;transition:all .3s ease}

    /* ‚ïê‚ïê DOWNLOAD BAR ‚ïê‚ïê */
    .dl-wrap{position:relative;display:inline-flex;align-items:center}
    .i-dl{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:#fff;background:rgba(110,80,255,.75);padding:7px 10px 7px 16px;border-radius:8px 0 0 8px;text-decoration:none;cursor:pointer;border:none;transition:background .18s;white-space:nowrap}
    .i-dl:hover{background:rgba(110,80,255,1)}
    .dl-fmt-btn{background:rgba(110,80,255,.75);border:none;border-left:1px solid rgba(255,255,255,.15);border-radius:0 8px 8px 0;padding:7px 9px;color:#fff;cursor:pointer;font-size:11px;transition:background .18s}
    .dl-fmt-btn:hover{background:rgba(110,80,255,1)}
    .dl-dropdown{position:absolute;bottom:calc(100% + 6px);left:0;background:#1a1a2e;border:1px solid rgba(110,80,255,.3);border-radius:10px;overflow:hidden;display:none;flex-direction:column;z-index:100;box-shadow:0 8px 30px rgba(0,0,0,.5);min-width:160px}
    .dl-dropdown.open{display:flex}
    .dl-opt{font-family:'DM Mono',monospace;font-size:11px;padding:10px 16px;color:var(--txt);cursor:pointer;display:flex;align-items:center;gap:10px;transition:background .15s;border:none;background:transparent;text-align:left;width:100%}
    .dl-opt:hover{background:rgba(110,80,255,.15);color:#fff}
    .dl-opt .fmt-badge{font-size:9px;font-weight:700;letter-spacing:.1em;padding:2px 7px;border-radius:4px}
    .dl-opt.png .fmt-badge{background:rgba(52,211,153,.15);color:#34d399}
    .dl-opt.jpg .fmt-badge{background:rgba(251,191,36,.15);color:#fbbf24}
    .dl-opt-desc{font-size:9px;color:var(--sub);display:block;margin-top:1px}
    .i-share{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--wh);background:rgba(52,211,153,.2);border:1px solid rgba(52,211,153,.3);padding:7px 14px;border-radius:8px;cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:6px}
    .i-share:hover{background:rgba(52,211,153,.35)}
    .i-size-tag{font-family:'DM Mono',monospace;font-size:10px;color:var(--sub);background:var(--card);border:1px solid var(--bdr);padding:6px 12px;border-radius:8px}

    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
    .blink-txt{animation:blink 1.1s ease-in-out infinite}
    .load-dots,.spinner,.pulse-dot,.load-row,.chevrons{display:none}

    .result-img-outer{display:flex;flex-direction:column;align-items:flex-start;gap:10px}
    .result-img-wrap{max-height:420px;width:auto;border-radius:12px;overflow:hidden;position:relative;border:1px solid var(--bdr);background:var(--card);flex-shrink:0;cursor:zoom-in}
    .result-img-wrap img{height:100%;width:auto;max-height:420px;display:block;border-radius:12px;transition:opacity .5s ease}
    .img-dl-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .err-card{width:100%;min-height:120px;border-radius:12px;border:1px solid rgba(248,113,113,.2);background:rgba(248,113,113,.05);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:24px}
    .err-ico{font-size:26px}
    .err-msg{font-family:'DM Mono',monospace;font-size:12px;color:var(--err);text-align:center}

    .recent-col{width:76px;flex-shrink:0;height:100%;background:var(--surf);display:flex;flex-direction:column;overflow:hidden}
    .rc-hdr{height:52px;flex-shrink:0;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:center}
    .rc-lbl{font-family:'Syne',sans-serif;font-size:8px;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--sub)}
    .rc-scroll{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px 7px;display:flex;flex-direction:column;gap:7px;align-items:center}
    .rc-scroll::-webkit-scrollbar{width:2px}
    .rc-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
    .rc-thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:2px solid var(--bdr);cursor:pointer;flex-shrink:0;transition:all .2s;display:block}
    .rc-thumb:hover{border-color:var(--acc);transform:scale(1.06)}
    .rc-thumb.active{border-color:var(--alit);box-shadow:0 0 0 2px rgba(155,125,255,.3)}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       LIGHTBOX ‚Äî Full screen KlingAI style
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #lightbox{
      position:fixed;inset:0;z-index:999;
      background:rgba(0,0,0,.92);backdrop-filter:blur(24px);
      display:none;opacity:0;
      transition:opacity .25s ease;
    }
    #lightbox.open{display:flex;opacity:1}

    .lb-shell{
      width:100%;height:100%;
      display:flex;flex-direction:column;
    }

    /* Top bar */
    .lb-topbar{
      height:56px;flex-shrink:0;
      display:flex;align-items:center;
      padding:0 24px;gap:14px;
      border-bottom:1px solid rgba(255,255,255,.07);
      background:rgba(8,8,16,.7);
    }
    .lb-logo{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--wh);letter-spacing:-.02em}
    .lb-logo span{color:var(--acc)}
    .lb-divider{width:1px;height:18px;background:var(--bdr)}
    .lb-size-badge{
      font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.15em;
      text-transform:uppercase;color:var(--sub);
      background:rgba(255,255,255,.05);border:1px solid var(--bdr);
      padding:4px 12px;border-radius:6px;white-space:nowrap;
    }
    .lb-spacer{flex:1}
    .lb-close-btn{
      width:36px;height:36px;border-radius:50%;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      color:var(--wh);font-size:16px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:all .18s;
    }
    .lb-close-btn:hover{background:rgba(248,113,113,.25);border-color:rgba(248,113,113,.4)}

    /* Main area: image + right panel */
    .lb-main{
      flex:1;display:flex;overflow:hidden;min-height:0;
    }

    /* Image area ‚Äî takes most space */
    .lb-img-area{
      flex:1;min-width:0;
      display:flex;align-items:center;justify-content:center;
      padding:32px;overflow:hidden;
    }
    .lb-img-wrap{
      max-width:100%;max-height:100%;
      border-radius:12px;overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 24px 80px rgba(0,0,0,.6);
    }
    #lb-img{
      display:block;
      max-width:min(calc(100vw - 380px), 900px);
      max-height:calc(100vh - 160px);
      object-fit:contain;
      border-radius:12px;
    }

    /* Right info panel */
    .lb-panel{
      width:320px;flex-shrink:0;
      background:rgba(12,12,28,.8);
      border-left:1px solid rgba(255,255,255,.07);
      display:flex;flex-direction:column;
      padding:28px 24px;gap:20px;
      overflow-y:auto;
    }
    .lb-panel::-webkit-scrollbar{width:3px}
    .lb-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}

    .lb-section-label{
      font-family:'DM Mono',monospace;font-size:9px;
      letter-spacing:.2em;text-transform:uppercase;
      color:var(--mut);margin-bottom:8px;
    }

    /* Prompt card */
    .lb-prompt-card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.07);
      border-radius:12px;padding:14px;
    }
    .lb-prompt-text{
      font-family:'DM Mono',monospace;font-size:12px;
      color:var(--txt);line-height:1.8;
      word-break:break-word;
    }
    .lb-copy-btn{
      margin-top:12px;width:100%;
      font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
      letter-spacing:.08em;text-transform:uppercase;
      background:rgba(110,80,255,.15);border:1px solid rgba(110,80,255,.3);
      color:var(--alit);padding:9px;border-radius:8px;
      cursor:pointer;transition:all .18s;
    }
    .lb-copy-btn:hover{background:rgba(110,80,255,.28)}
    .lb-copy-btn.copied{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.35);color:var(--ok)}

    /* Actions */
    .lb-actions{display:flex;flex-direction:column;gap:10px}
    /* Format selector pills */
    .lb-fmt-row{display:flex;gap:6px;margin-bottom:2px}
    .lb-fmt-pill{
      font-family:'DM Mono',monospace;font-size:11px;font-weight:400;
      letter-spacing:.1em;text-transform:uppercase;
      border-radius:8px;padding:7px 18px;cursor:pointer;
      border:1px solid rgba(255,255,255,.12);background:transparent;
      color:var(--sub);transition:all .18s;flex:1;text-align:center;
    }
    .lb-fmt-pill:hover{border-color:rgba(110,80,255,.4);color:var(--txt)}
    .lb-fmt-pill.active.png{border-color:#34d399;background:rgba(52,211,153,.12);color:#34d399}
    .lb-fmt-pill.active.jpg{border-color:#fbbf24;background:rgba(251,191,36,.1);color:#fbbf24}
    .lb-dl-btn{
      width:100%;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
      letter-spacing:.06em;text-transform:uppercase;
      color:#fff;background:rgba(110,80,255,.85);
      border:none;border-radius:10px;
      padding:13px 14px;cursor:pointer;transition:background .18s;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .lb-dl-btn:hover{background:var(--acc)}

    .lb-share-btn{
      width:100%;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
      letter-spacing:.06em;text-transform:uppercase;
      color:var(--wh);background:rgba(52,211,153,.18);
      border:1px solid rgba(52,211,153,.3);
      border-radius:10px;padding:11px 14px;cursor:pointer;
      transition:all .18s;display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .lb-share-btn:hover{background:rgba(52,211,153,.3)}

    /* Image info */
    .lb-info-row{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .lb-info-chip{
      font-family:'DM Mono',monospace;font-size:10px;
      color:var(--sub);background:rgba(255,255,255,.04);
      border:1px solid var(--bdr);padding:5px 12px;border-radius:6px;
    }

    @media(max-width:1100px){.sidebar{width:380px;min-width:360px}}
    @media(max-width:860px){.sidebar{width:300px;min-width:280px}.recent-col{width:62px}.rc-thumb{width:46px;height:46px}}

    /* ‚ïê‚ïê MOBILE ‚ïê‚ïê */
    @media(max-width:767px){
      html,body{height:100%;overflow:hidden}
      .shell{flex-direction:column;height:calc(100vh - 52px);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
      .recent-col{display:none}
      .sidebar{width:100%;min-width:0;height:auto;flex-shrink:0;border-right:none;border-bottom:1px solid var(--bdr);overflow:visible}
      .feed-col{width:100%;min-width:0;height:auto;flex-shrink:0;border-right:none;overflow:visible;display:flex;flex-direction:column}
      .feed-empty{min-height:260px;flex:none}
      .feed-scroll{overflow:visible;height:auto;flex:none}
      header{padding:0 16px;gap:10px}
      .logo{font-size:18px}
      .htag{display:none}
      .clear-btn{font-size:10px;padding:6px 10px}
      .sec{padding:16px 18px}
      .ad-slot{padding:12px 18px 0}
      .ad-box{width:100%;max-width:300px}
      .gsec{padding:14px 18px 18px;margin-top:0;border-top:1px solid var(--bdr);background:var(--surf)}
      .sgrp.on{grid-template-columns:repeat(2,1fr)}
      .sgrp4.on{grid-template-columns:repeat(2,1fr)}
      .batch-img-area{padding:0 14px 16px}
      .bh{padding:12px 14px 10px;gap:7px;flex-wrap:wrap}
      .bh-badge{font-size:9px;padding:2px 7px}
      .bh-prompt{font-size:11px;min-width:0}
      .bh-actions{flex-wrap:wrap}
      .result-img-wrap{max-height:none!important;width:100%!important;aspect-ratio:unset!important;cursor:default}
      .result-img-wrap img{width:100%!important;height:auto!important;max-height:none!important}
      .load-card{min-height:200px}
      .fe-title{font-size:18px}
      .fe-sub{font-size:10px}
      .fe-ico{width:58px;height:58px;font-size:22px}
      /* Mobile lightbox ‚Äî simple fullscreen */
      #lightbox{display:none!important}
    }
  </style>
</head>
<body>
<div class="orb o1"></div>
<div class="orb o2"></div>

<header>
  <a class="logo" href="#"><span>B</span>reezyfy</a>
  <div class="hd"></div>
  <span class="htag">Create without Limits</span>
  <div style="flex:1"></div>
  <button class="clear-btn" id="clearBtn" onclick="clearAllImages()" style="display:none">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
    Clear All
  </button>
</header>

<div class="shell" id="shell">
  <aside class="sidebar" id="sidebar">
    <div class="sec">
      <div class="slbl">Prompt</div>
      <div class="pw">
        <textarea id="prompt" placeholder="Describe your image ‚Äî subject, style, lighting, mood‚Ä¶" maxlength="800" oninput="uc(this)"></textarea>
        <span class="cc"><span id="cn">0</span>/800</span>
        <button class="magic-btn" id="magicBtn" onclick="insertMagicPrompt()" title="Magic Prompt ‚ú®">‚ú¶</button>
      </div>
    </div>
    <div class="sec">
      <div class="slbl">Negative Prompt</div>
      <textarea id="neg">ugly, blurry, low quality, deformed, bad anatomy, extra limbs, watermark, text, signature, cropped, worst quality, jpeg artifacts, noise, overexposed, underexposed</textarea>
    </div>
    <div class="sec">
      <div class="slbl">Canvas Size</div>
      <div class="stabs">
        <button class="stab on" onclick="st('sq',this)">Square</button>
        <button class="stab" onclick="st('po',this)">Portrait</button>
        <button class="stab" onclick="st('la',this)">Landscape</button>
        <button class="stab" onclick="st('cu',this)">Custom</button>
      </div>
      <div class="sgrp on" id="g-sq">
        <input type="radio" name="sz" id="sq1" value="512,512" checked>
        <label class="scard" for="sq1"><div class="svis"><div class="srect" style="width:21px;height:21px"></div></div><div class="srat">1:1</div><div class="spx">512 px</div></label>
        <input type="radio" name="sz" id="sq2" value="768,768">
        <label class="scard" for="sq2"><div class="svis"><div class="srect" style="width:25px;height:25px"></div></div><div class="srat">1:1</div><div class="spx">768 px</div></label>
        <input type="radio" name="sz" id="sq3" value="1024,1024">
        <label class="scard" for="sq3"><div class="svis"><div class="srect" style="width:29px;height:29px"></div></div><div class="srat">1:1</div><div class="spx">1024 px</div></label>
      </div>
      <div class="sgrp4" id="g-po">
        <input type="radio" name="sz" id="po1" value="512,768">
        <label class="scard" for="po1"><div class="svis"><div class="srect" style="width:16px;height:24px"></div></div><div class="srat">2:3</div><div class="spx">512√ó768</div></label>
        <input type="radio" name="sz" id="po2" value="576,1024">
        <label class="scard" for="po2"><div class="svis"><div class="srect" style="width:14px;height:25px"></div></div><div class="srat">9:16</div><div class="spx">576√ó1024</div></label>
        <input type="radio" name="sz" id="po3" value="768,1024">
        <label class="scard" for="po3"><div class="svis"><div class="srect" style="width:18px;height:24px"></div></div><div class="srat">3:4</div><div class="spx">768√ó1024</div></label>
        <input type="radio" name="sz" id="po4" value="832,1216">
        <label class="scard" for="po4"><div class="svis"><div class="srect" style="width:16px;height:23px"></div></div><div class="srat">2:3</div><div class="spx">832√ó1216</div></label>
      </div>
      <div class="sgrp4" id="g-la">
        <input type="radio" name="sz" id="la1" value="768,512">
        <label class="scard" for="la1"><div class="svis"><div class="srect" style="width:25px;height:17px"></div></div><div class="srat">3:2</div><div class="spx">768√ó512</div></label>
        <input type="radio" name="sz" id="la2" value="1024,576">
        <label class="scard" for="la2"><div class="svis"><div class="srect" style="width:27px;height:15px"></div></div><div class="srat">16:9</div><div class="spx">1024√ó576</div></label>
        <input type="radio" name="sz" id="la3" value="1024,768">
        <label class="scard" for="la3"><div class="svis"><div class="srect" style="width:25px;height:19px"></div></div><div class="srat">4:3</div><div class="spx">1024√ó768</div></label>
        <input type="radio" name="sz" id="la4" value="1280,720">
        <label class="scard" for="la4"><div class="svis"><div class="srect" style="width:28px;height:16px"></div></div><div class="srat">16:9</div><div class="spx">1280√ó720</div></label>
      </div>
      <div class="cgrp" id="g-cu">
        <div class="crow">
          <div class="diw"><span class="dilbl">W</span><input class="diin" type="number" id="dimW" value="872" min="256" max="2048" step="64"></div>
          <button class="ibtn lk" id="lkBtn" onclick="toggleLock()">üîí</button>
          <div class="diw"><span class="dilbl">H</span><input class="diin" type="number" id="dimH" value="1024" min="256" max="2048" step="64"></div>
          <button class="ibtn" onclick="swapDims()">‚áÖ</button>
        </div>
        <button class="appbtn" id="appBtn" onclick="applyCustom()">Apply Custom Size</button>
      </div>
    </div>
    <div class="gsec">
      <button id="genBtn" onclick="generate()"><span class="shim"></span>Generate</button>
    </div>
  </aside>

  <div class="feed-col" id="feedCol">
    <div class="feed-empty" id="feedEmpty">
      <div class="fe-ico">‚óà</div>
      <div class="fe-title">Canvas awaits</div>
      <div class="fe-sub">Write a prompt and press Generate<br/>Your images will appear here</div>
    </div>
    <div class="feed-scroll" id="feedScroll"></div>
  </div>

  <aside class="recent-col">
    <div class="rc-hdr"><span class="rc-lbl">Recent</span></div>
    <div class="rc-scroll" id="rcScroll"></div>
  </aside>
</div>

<!-- ‚ïê‚ïê LIGHTBOX ‚ïê‚ïê -->
<div id="lightbox">
  <div class="lb-shell">
    <!-- Top bar -->
    <div class="lb-topbar">
      <div class="lb-logo"><span>B</span>reezyfy</div>
      <div class="lb-divider"></div>
      <span class="lb-size-badge" id="lb-size">‚Äî</span>
      <div class="lb-spacer"></div>
      <button class="lb-close-btn" onclick="closeLightbox()">‚úï</button>
    </div>
    <!-- Main -->
    <div class="lb-main">
      <!-- Image -->
      <div class="lb-img-area" id="lb-img-area" onclick="lbBgClick(event)">
        <div class="lb-img-wrap">
          <img id="lb-img" src="" alt=""/>
        </div>
      </div>
      <!-- Right panel -->
      <div class="lb-panel">
        <!-- Prompt -->
        <div>
          <div class="lb-section-label">Prompt</div>
          <div class="lb-prompt-card">
            <div class="lb-prompt-text" id="lb-prompt-txt">‚Äî</div>
            <button class="lb-copy-btn" id="lb-copy-btn" onclick="lbCopyPrompt()">Copy Prompt</button>
          </div>
        </div>
        <!-- Image info -->
        <div>
          <div class="lb-section-label">Details</div>
          <div class="lb-info-row">
            <span class="lb-info-chip" id="lb-info-size">‚Äî</span>
            <span class="lb-info-chip">AI Generated</span>
            <span class="lb-info-chip">Breezyfy</span>
          </div>
        </div>
        <!-- Actions -->
        <div>
          <div class="lb-section-label">Download & Share</div>
          <div class="lb-actions">
            <!-- Format selector -->
            <div class="lb-fmt-row">
              <button class="lb-fmt-pill png active" id="lb-fmt-png" onclick="lbSelectFmt('png')">PNG</button>
              <button class="lb-fmt-pill jpg" id="lb-fmt-jpg" onclick="lbSelectFmt('jpg')">JPG</button>
            </div>
            <!-- Download button -->
            <button class="lb-dl-btn" id="lb-dl-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Download PNG
            </button>
            <!-- Share button -->
            <button class="lb-share-btn" id="lb-share-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
              Share Image
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function uc(el){ document.getElementById('cn').textContent = el.value.length; }

/* ‚ïê‚ïê MAGIC PROMPTS ‚ïê‚ïê */
const MAGIC_PROMPTS = [
  "A stunning female warrior in iridescent armor standing on a cliff edge at golden hour, epic fantasy, cinematic lighting, ultra-detailed, 8K",
  "Cyberpunk city at night, neon reflections on wet streets, a lone figure with umbrella, blade runner aesthetic, rain, volumetric fog, photorealistic",
  "Ancient Japanese temple surrounded by cherry blossoms, misty morning, soft diffused light, traditional architecture, peaceful atmosphere, 4K",
  "A majestic lion made entirely of galaxies and nebulae, cosmic art, deep space background, intricate detail, vivid colors, digital art masterpiece",
  "Underwater palace with glowing bioluminescent creatures, deep sea, ethereal light rays, coral kingdom, cinematic, hyper-realistic",
  "Portrait of a mysterious woman with galaxy eyes, bokeh background, studio lighting, dramatic shadows, fashion photography, ultra-sharp",
  "Vast desert at sunset with a lone traveler on camelback, sand dunes casting long shadows, warm orange hues, cinematic wide shot",
  "Enchanted forest with giant glowing mushrooms, fireflies, fairy lights, magical atmosphere, detailed foliage, fantasy concept art",
  "Futuristic spaceship cockpit view approaching a ringed gas giant, stars, lens flare, photorealistic, sci-fi, cinematic composition",
  "A dragon perched on a Gothic cathedral in a stormy night sky, lightning, dramatic clouds, oil painting style, epic fantasy",
  "Aerial view of a tropical island with crystal clear turquoise water, white sand beach, lush jungle, golden hour, travel photography",
  "Vintage 1920s jazz club, warm amber light, smoke haze, musicians on stage, art deco interior, cinematic atmosphere, detailed",
  "A powerful thunderstorm over ocean, massive waves, lightning striking water, dramatic sky, moody color grading, photorealistic",
  "Ancient Roman colosseum at sunset, golden light, detailed stone textures, historical atmosphere, wide angle, sharp details",
  "Ethereal forest spirit made of light and mist, flowing robes, surrounding fireflies, magical realism, pastel color palette",
  "Steampunk clockwork city with giant gears, hot air balloons, brass towers, vintage aesthetic, intricate mechanical details, warm tones",
  "Dramatic portrait of an old wise man with weathered face, intense eyes, natural light from window, high contrast, photorealistic",
  "A serene Japanese zen garden with raked sand, bonsai trees, stone lanterns, cherry blossom petals falling, golden hour light",
  "Massive ice castle in arctic landscape, northern lights (aurora borealis), ultra-detailed, fantasy architecture, blue and green hues",
  "A phoenix rising from ashes, fire and embers, intense orange and red, dramatic lighting, mythological, digital painting, epic scale",
  "Luxury penthouse interior at night, floor-to-ceiling windows, city lights, minimalist design, warm mood lighting, architectural photography",
  "Cute fluffy cat wearing a tiny astronaut helmet in space, Earth in background, floating, adorable, photorealistic, funny",
  "Dense rainforest with shafts of sunlight piercing through canopy, exotic birds, mist, rich greens, nature photography, 4K",
  "Abstract fluid art with metallic gold and deep blue, swirling patterns, high gloss texture, macro photography, wallpaper",
  "A superhero silhouette against a massive full moon over a city skyline, dramatic contrast, dark atmosphere, comic book style",
];

let lastMagicIdx = -1;
function insertMagicPrompt(){
  const btn = document.getElementById('magicBtn');
  btn.classList.remove('spin');
  void btn.offsetWidth; // reflow to restart animation
  btn.classList.add('spin');

  // Pick random prompt ‚Äî never repeat same twice in a row
  let idx;
  do { idx = Math.floor(Math.random() * MAGIC_PROMPTS.length); } while(idx === lastMagicIdx);
  lastMagicIdx = idx;

  const ta = document.getElementById('prompt');
  ta.value = MAGIC_PROMPTS[idx];
  uc(ta);
  ta.focus();
  // Flash effect on textarea
  ta.style.borderColor = 'rgba(110,80,255,.8)';
  ta.style.boxShadow = '0 0 0 3px rgba(110,80,255,.15)';
  setTimeout(()=>{ ta.style.borderColor=''; ta.style.boxShadow=''; }, 600);
}

function st(tab, btn) {
  document.querySelectorAll('.stab').forEach(b => b.classList.remove('on'));
  document.querySelectorAll('.sgrp, .sgrp4').forEach(g => { g.classList.remove('on'); g.style.display = 'none'; });
  document.getElementById('g-cu').classList.remove('on'); document.getElementById('g-cu').style.display = 'none';
  btn.classList.add('on');
  if (tab === 'cu') { const g = document.getElementById('g-cu'); g.classList.add('on'); g.style.display = 'flex'; }
  else { const g = document.getElementById('g-' + tab); g.classList.add('on'); g.style.display = 'grid'; }
}

let aspectLocked = true, aspectRatio = 872/1024, customApplied = false;
function toggleLock() {
  aspectLocked = !aspectLocked;
  const btn = document.getElementById('lkBtn');
  btn.textContent = aspectLocked ? 'üîí' : 'üîì'; btn.classList.toggle('lk', aspectLocked);
  if (aspectLocked) aspectRatio = (parseFloat(document.getElementById('dimW').value)||512) / (parseFloat(document.getElementById('dimH').value)||512);
}
document.getElementById('dimW').addEventListener('input', function(){ if (!aspectLocked) return; document.getElementById('dimH').value = Math.round((parseFloat(this.value)||512) / aspectRatio); resetApply(); });
document.getElementById('dimH').addEventListener('input', function(){ if (!aspectLocked) return; document.getElementById('dimW').value = Math.round((parseFloat(this.value)||512) * aspectRatio); resetApply(); });
function resetApply(){ customApplied=false; const b=document.getElementById('appBtn'); b.classList.remove('done'); b.textContent='Apply Custom Size'; }
function swapDims(){ const w=document.getElementById('dimW'),h=document.getElementById('dimH'); [w.value,h.value]=[h.value,w.value]; if(aspectLocked) aspectRatio=parseFloat(w.value)/parseFloat(h.value); resetApply(); }
function applyCustom(){ customApplied=true; const b=document.getElementById('appBtn'); b.classList.add('done'); b.textContent='‚úì Applied'; }
function getDims(){
  const tab = document.querySelector('.stab.on').textContent.trim().toLowerCase();
  if (tab==='custom'){ if(!customApplied) applyCustom(); return [Math.max(256,Math.min(2048,parseInt(document.getElementById('dimW').value)||512)),Math.max(256,Math.min(2048,parseInt(document.getElementById('dimH').value)||512))]; }
  return document.querySelector('input[name="sz"]:checked').value.split(',').map(Number);
}

function isMobile(){ return window.innerWidth <= 767; }
function scrollToEl(el){
  if(isMobile()){ const s=document.getElementById('shell'); s.scrollTo({top:el.getBoundingClientRect().top+s.scrollTop-12,behavior:'smooth'}); }
  else el.scrollIntoView({behavior:'smooth',block:'start'});
}
function showFeed(){ document.getElementById('feedEmpty').style.display='none'; document.getElementById('feedScroll').style.display='flex'; }

const MSGS = ['Sampling latents‚Ä¶','Refining details‚Ä¶','Decoding image‚Ä¶','Almost ready‚Ä¶'];
let progTimer, progIdx=0, activeBatch=null;

function updateLoadingMsg(msg, sublbl, queueNum, pct){
  try {
    if(!activeBatch) return;
    const card=activeBatch.loadCard;
    const lbl=card.querySelector('#lc-lbl'), sub=card.querySelector('#lc-sublbl');
    const badge=card.querySelector('#lc-badge'), pctNum=card.querySelector('#lc-pct-num'), pctSub=card.querySelector('#lc-pct-sub');
    if(lbl && msg) lbl.innerHTML=msg;
    if(sub && sublbl!==undefined) sub.textContent=sublbl;
    if(queueNum!==undefined && queueNum>0){ if(badge){badge.textContent='Queue #'+queueNum;badge.style.color='rgba(155,125,255,.8)'} if(pctNum) pctNum.textContent='#'+queueNum; if(pctSub) pctSub.textContent='QUEUE'; }
    else if(queueNum===0){ if(badge){badge.textContent='Generating ‚ú®';badge.style.color='rgba(52,211,153,.9)'} }
    if(pct!==undefined){
      const ring=card.querySelector('#lc-ring'), fill=card.querySelector('#lc-ring-fill');
      if(ring) ring.classList.add('visible');
      if(fill) fill.style.strokeDashoffset=376-(376*pct/100);
      if(pctNum) pctNum.textContent=Math.round(pct); if(pctSub) pctSub.textContent='%';
    }
  } catch(e){ console.warn('updateMsg:',e.message); }
}

let fakeProgressTimer=null, fakeProgressVal=0;
function startFakeProgress(){
  fakeProgressVal=0; if(fakeProgressTimer) clearInterval(fakeProgressTimer);
  fakeProgressTimer=setInterval(()=>{ const r=95-fakeProgressVal; fakeProgressVal=Math.min(95,fakeProgressVal+r*0.05+0.4); updateLoadingMsg('Creating your image...','almost there',0,fakeProgressVal); },700);
}
function completeFakeProgress(cb){
  if(fakeProgressTimer){clearInterval(fakeProgressTimer);fakeProgressTimer=null;}
  updateLoadingMsg('Image ready!','',0,100); setTimeout(cb,400);
}

function addLoadingBatch(promptText, imgW, imgH){
  showFeed();
  const feed=document.getElementById('feedScroll');
  const batch=document.createElement('div'); batch.className='batch';
  const bh=document.createElement('div'); bh.className='bh';
  bh.innerHTML=`<svg class="bh-img-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><div class="bh-divider"></div><div class="bh-badge hi">Breezyfy</div><div class="bh-badge">${imgW} √ó ${imgH}</div><div class="bh-prompt">${promptText}</div>`;
  const imgArea=document.createElement('div'); imgArea.className='batch-img-area';
  const loadCard=document.createElement('div'); loadCard.className='load-card';
  const fw=document.getElementById('feedCol').clientWidth-40;
  loadCard.style.height=Math.max(200,Math.min(480,Math.round(fw*(imgH/imgW))))+'px';
  loadCard.innerHTML=`
    <div class="load-grid"></div><div class="load-glow"></div>
    <div class="particles" id="lc-particles"></div>
    <div class="queue-badge" id="lc-badge">Preparing...</div>
    <div class="orb-wrap">
      <svg class="progress-ring" id="lc-ring" viewBox="0 0 140 140">
        <defs><linearGradient id="progGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#6e50ff"/><stop offset="100%" style="stop-color:#9b7dff"/></linearGradient></defs>
        <circle class="track" cx="70" cy="70" r="60"/><circle class="fill" id="lc-ring-fill" cx="70" cy="70" r="60"/>
      </svg>
      <div class="ring-outer"></div><div class="ring-mid"></div>
      <div class="orb-inner"><div class="pct-text" id="lc-pct"><span id="lc-pct-num">‚Äì</span><span class="pct-sub" id="lc-pct-sub">QUEUE</span></div></div>
    </div>
    <div class="load-status"><div class="load-lbl" id="lc-lbl">In queue...</div><div class="load-sublbl" id="lc-sublbl">please wait</div></div>`;
  const pCont=loadCard.querySelector('#lc-particles');
  for(let i=0;i<14;i++){ const p=document.createElement('div'); p.className='particle'; const sz=Math.random()*3+2,a=Math.random()*Math.PI*2,d=50+Math.random()*70; p.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+(42+Math.random()*16)+'%;top:'+(42+Math.random()*16)+'%;--dur:'+(2+Math.random()*3)+'s;--del:'+(Math.random()*2)+'s;--tx:'+(Math.cos(a)*d)+'px;--ty:'+(Math.sin(a)*d)+'px'; pCont.appendChild(p); }
  setTimeout(()=>{ const pt=loadCard.querySelector('#lc-pct'); if(pt) pt.classList.add('visible'); },300);
  imgArea.appendChild(loadCard); batch.appendChild(bh); batch.appendChild(imgArea);
  feed.insertBefore(batch,feed.firstChild);
  setTimeout(()=>scrollToEl(batch),80);
  activeBatch={batch,bh,imgArea,loadCard,promptText,imgW,imgH};
  progIdx=0; clearInterval(progTimer);
  const txtEl=loadCard.querySelector('.load-lbl');
  progTimer=setInterval(()=>{ progIdx=(progIdx+1)%MSGS.length; if(txtEl) txtEl.textContent=MSGS[progIdx]; },2400);
}

function resolveLoading(src){
  clearInterval(progTimer);
  if(!activeBatch) return;
  const {bh,imgArea,promptText,imgW,imgH}=activeBatch; activeBatch=null;
  bh.innerHTML=`<svg class="bh-img-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><div class="bh-divider"></div><div class="bh-badge hi">Breezyfy</div><div class="bh-badge">${imgW} √ó ${imgH}</div><div class="bh-prompt">${promptText}</div><div class="bh-actions">${buildBhDl(src,imgW,imgH)}</div>`;
  imgArea.innerHTML='';
  // Side-by-side row: image left, ad right
  const row=document.createElement('div'); row.className='batch-img-row';
  const imgCol=document.createElement('div'); imgCol.className='batch-img-col';
  const adCol=document.createElement('div'); adCol.className='batch-ad-col';

  const outer=document.createElement('div'); outer.className='result-img-outer';
  const imgWrap=document.createElement('div'); imgWrap.className='result-img-wrap'; imgWrap.style.aspectRatio=`${imgW}/${imgH}`;
  const img=document.createElement('img'); img.src=src; img.alt=promptText; img.style.opacity='0'; img.style.transition='opacity .5s ease'; img.onload=()=>{ img.style.opacity='1'; };
  imgWrap.appendChild(img);
  if(!isMobile()) imgWrap.onclick=()=>openLightbox(src,promptText,imgW,imgH);
  const dlBar=document.createElement('div'); dlBar.className='img-dl-bar'; dlBar.innerHTML=buildDlBar(src,imgW,imgH);
  outer.appendChild(imgWrap); outer.appendChild(dlBar); imgCol.appendChild(outer);

  // Inject ad into right column
  injectAd(adCol);

  row.appendChild(imgCol); row.appendChild(adCol);
  imgArea.appendChild(row);
  addToRecent(src,imgW,imgH);
}

function errorLoading(msg){
  clearInterval(progTimer);
  if(!activeBatch) return;
  const {imgArea}=activeBatch; activeBatch=null;
  imgArea.innerHTML=`<div class="err-card"><div class="err-ico">‚ö†</div><div class="err-msg">${msg}</div></div>`;
}

/* ‚ïê‚ïê AD INJECTION ‚ïê‚ïê */
const AD_KEY = '72753c259be03858d74032452ad2f30c';
let adCount = 0;

function injectAd(container) {
  adCount++;
  const wrap = document.createElement('div');
  wrap.className = 'ad-unit-wrap';
  wrap.id = 'ad_slot_' + adCount;
  container.appendChild(wrap);

  // Use srcdoc ‚Äî safest way to inject ads without breaking parent HTML
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'width:728px;max-width:100%;height:90px;border:none;border-radius:6px;display:block;';
  iframe.scrolling = 'no';
  iframe.setAttribute('frameborder', '0');

  const html = [
    '<!DOCTYPE html><html><head>',
    '<style>*{margin:0;padding:0;overflow:hidden;box-sizing:border-box}</style>',
    '</head><body>',
    '<scr'+'ipt>',
    "atOptions={'key':'"+AD_KEY+"','format':'iframe','height':90,'width':728,'params':{}};",
    '</scr'+'ipt>',
    '<scr'+'ipt src="https://www.highperformanceformat.com/'+AD_KEY+'/invoke.js"></scr'+'ipt>',
    '</body></html>'
  ].join('');

  iframe.srcdoc = html;
  wrap.appendChild(iframe);
}

/* ‚ïê‚ïê CLEAR ‚ïê‚ïê */
const recentSrcs=[];
function clearAllImages(){
  if(!confirm('Clear all generated images? This cannot be undone.')) return;
  localStorage.removeItem('breezyfy_images'); recentSrcs.length=0;
  document.getElementById('rcScroll').innerHTML=''; document.getElementById('feedScroll').innerHTML='';
  document.getElementById('feedScroll').style.display='none'; document.getElementById('feedEmpty').style.display='flex';
  document.getElementById('clearBtn').style.display='none';
}

/* ‚ïê‚ïê SHARE ‚ïê‚ïê */
async function shareImage(src, imgW, imgH){
  try {
    const res=await fetch(src), blob=await res.blob();
    const file=new File([blob],`breezyfy_${imgW}x${imgH}.png`,{type:'image/png'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({title:'Breezyfy AI Image',text:'Created with Breezyfy ‚Äî AI Image Generator',files:[file]}); return; }
    if(navigator.clipboard && window.ClipboardItem){ await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]); showToast('Image copied to clipboard!'); return; }
    window.open(src,'_blank');
  } catch(e){ if(e.name!=='AbortError') showToast('Could not share image'); }
}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
function showToast(msg){
  let t=document.getElementById('bfy-toast');
  if(!t){ t=document.createElement('div'); t.id='bfy-toast'; t.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:#1a1a2e;border:1px solid rgba(110,80,255,.4);color:#e4e4f0;font-family:DM Mono,monospace;font-size:12px;padding:10px 20px;border-radius:10px;z-index:9999;opacity:0;transition:all .3s ease;pointer-events:none;white-space:nowrap;'; document.body.appendChild(t); }
  t.textContent=msg; t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(0)';
  clearTimeout(t._timer); t._timer=setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(20px)'; },2500);
}

/* ‚ïê‚ïê DOWNLOAD ‚ïê‚ïê */
function downloadAs(src, fmt, imgW, imgH){
  const canvas=document.createElement('canvas'), img=new Image();
  img.onload=()=>{
    canvas.width=img.naturalWidth||imgW; canvas.height=img.naturalHeight||imgH;
    const ctx=canvas.getContext('2d');
    if(fmt==='jpg'){ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
    ctx.drawImage(img,0,0);
    const a=document.createElement('a'); a.href=canvas.toDataURL(fmt==='jpg'?'image/jpeg':'image/png',fmt==='jpg'?0.95:1.0); a.download=`breezyfy_${imgW}x${imgH}.${fmt}`; a.click();
  }; img.src=src;
}

function buildDlBar(src, imgW, imgH){
  const id='dd_'+Math.random().toString(36).slice(2,7);
  setTimeout(()=>{
    const btn=document.getElementById('fmtbtn_'+id), dd=document.getElementById('dd_'+id);
    if(!btn||!dd) return;
    btn.onclick=(e)=>{ e.stopPropagation(); dd.classList.toggle('open'); };
    document.addEventListener('click',()=>dd.classList.remove('open'));
    dd.querySelectorAll('.dl-opt').forEach(opt=>{ opt.onclick=(e)=>{ e.stopPropagation(); downloadAs(src,opt.dataset.fmt,imgW,imgH); dd.classList.remove('open'); }; });
    const dlA=document.getElementById('dla_'+id); if(dlA) dlA.onclick=()=>downloadAs(src,'png',imgW,imgH);
    const sh=document.getElementById('share_'+id); if(sh) sh.onclick=()=>shareImage(src,imgW,imgH);
  },100);
  return `<div class="dl-wrap"><a class="i-dl" id="dla_${id}" href="javascript:void(0)">‚Üì Download PNG</a><button class="dl-fmt-btn" id="fmtbtn_${id}" title="Format">‚ñæ</button><div class="dl-dropdown" id="dd_${id}"><button class="dl-opt png" data-fmt="png"><span class="fmt-badge">PNG</span><span>Lossless quality<span class="dl-opt-desc">Best for AI art</span></span></button><button class="dl-opt jpg" data-fmt="jpg"><span class="fmt-badge">JPG</span><span>Smaller file size<span class="dl-opt-desc">95% quality</span></span></button></div></div><button class="i-share" id="share_${id}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>Share</button><span class="i-size-tag">${imgW} √ó ${imgH}</span>`;
}

function buildBhDl(src, imgW, imgH){
  const id='bh_'+Math.random().toString(36).slice(2,7);
  setTimeout(()=>{ const el=document.getElementById(id); if(el) el.onclick=()=>downloadAs(src,'png',imgW,imgH); },100);
  return `<a class="bh-dl" href="javascript:void(0)" id="${id}">‚Üì Download</a>`;
}

/* ‚ïê‚ïê RECENT / STORAGE ‚ïê‚ïê */
function addToRecent(src, imgW, imgH){
  recentSrcs.unshift({src,imgW,imgH}); if(recentSrcs.length>40) recentSrcs.pop(); renderRecent();
  try { localStorage.setItem('breezyfy_images',JSON.stringify(recentSrcs.map(i=>({src:i.src,imgW:i.imgW,imgH:i.imgH})))); } catch(e){}
  const cb=document.getElementById('clearBtn'); if(cb) cb.style.display='flex';
}
function renderRecent(){
  const strip=document.getElementById('rcScroll'); strip.innerHTML='';
  recentSrcs.forEach((item,idx)=>{
    const img=document.createElement('img'); img.className='rc-thumb'+(idx===0?' active':''); img.src=item.src; img.loading='lazy'; img.title=`${item.imgW}√ó${item.imgH}`;
    img.onclick=()=>{ const b=document.querySelectorAll('#feedScroll .batch'); if(b[idx]) b[idx].scrollIntoView({behavior:'smooth',block:'start'}); document.querySelectorAll('.rc-thumb').forEach(t=>t.classList.remove('active')); img.classList.add('active'); };
    strip.appendChild(img);
  });
}

/* ‚ïê‚ïê LIGHTBOX ‚ïê‚ïê */
let lbSrc='', lbPrompt='', lbW=0, lbH=0, lbActiveFmt='png';

function lbSelectFmt(fmt){
  lbActiveFmt=fmt;
  document.getElementById('lb-fmt-png').className='lb-fmt-pill png'+(fmt==='png'?' active':'');
  document.getElementById('lb-fmt-jpg').className='lb-fmt-pill jpg'+(fmt==='jpg'?' active':'');
  const dlBtn=document.getElementById('lb-dl-btn');
  if(dlBtn) dlBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download '+fmt.toUpperCase();
}

function openLightbox(src, promptText, imgW, imgH){
  if(isMobile()) return;
  lbSrc=src; lbPrompt=promptText; lbW=imgW; lbH=imgH;
  document.getElementById('lb-img').src=src;
  document.getElementById('lb-prompt-txt').textContent=promptText||'‚Äî';
  document.getElementById('lb-size').textContent=imgW+' √ó '+imgH+' px';
  document.getElementById('lb-info-size').textContent=imgW+' √ó '+imgH+' px';
  document.getElementById('lb-copy-btn').textContent='Copy Prompt'; document.getElementById('lb-copy-btn').classList.remove('copied');
  // Setup download + format pills
  lbActiveFmt = 'png';
  lbSelectFmt('png');
  document.getElementById('lb-dl-btn').onclick=()=>downloadAs(lbSrc, lbActiveFmt, lbW, lbH);
  document.getElementById('lb-share-btn').onclick=()=>shareImage(src,imgW,imgH);
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeLightbox(){ document.getElementById('lightbox').classList.remove('open'); document.body.style.overflow=''; }
function lbBgClick(e){ if(e.target===document.getElementById('lb-img-area')) closeLightbox(); }
function lbCopyPrompt(){
  if(!lbPrompt) return;
  navigator.clipboard.writeText(lbPrompt).then(()=>{ const btn=document.getElementById('lb-copy-btn'); btn.textContent='‚úì Copied!'; btn.classList.add('copied'); setTimeout(()=>{ btn.textContent='Copy Prompt'; btn.classList.remove('copied'); },2000); });
}
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeLightbox(); });

/* ‚ïê‚ïê API ‚ïê‚ïê */
const API_URL = 'https://matt-discussing-opinions-week.trycloudflare.com';
let pollTimer=null;
function stopPolling(){ try{ if(pollTimer){clearInterval(pollTimer);pollTimer=null;} }catch(e){} }
function resetBtn(){ try{ const btn=document.getElementById('genBtn'); if(btn){btn.disabled=false;btn.innerHTML='<span class="shim"></span>Generate';} }catch(e){} }
let wasProcessing=false;

async function pollJobStatus(jobId){
  try {
    const res=await fetch(`${API_URL}/job/${jobId}`); if(!res.ok) return;
    const data=await res.json();
    if(data.status==='queued'){
      const pos=data.position||1, secs=data.estimatedSeconds||0;
      const ts=secs>=60?Math.ceil(secs/60)+' min':secs+' sec';
      let msg,sub;
      if(pos===1){msg="You're next!";sub='almost your turn';}
      else if(pos===2){msg='<span class="blink-txt">You are next in queue...</span>';sub='';}
      else{msg=pos+' ahead in queue';sub='~'+ts+' estimated';}
      updateLoadingMsg(msg,sub,pos); wasProcessing=false;
    } else if(data.status==='processing'){
      const rp=data.progress||0;
      if(!wasProcessing){ wasProcessing=true; if(fakeProgressTimer){clearInterval(fakeProgressTimer);fakeProgressTimer=null;} startFakeProgress(); }
      updateLoadingMsg('Creating your image...','almost there',0,rp>0?rp:undefined);
    } else if(data.status==='done'){
      stopPolling(); localStorage.removeItem('breezyfy_jobId');
      updateLoadingMsg('Image ready!','',0,100);
      setTimeout(()=>{ if(data.image) resolveLoading('data:image/png;base64,'+data.image); else errorLoading('No image received'); resetBtn(); },500);
    } else if(data.status==='error'){
      stopPolling(); localStorage.removeItem('breezyfy_jobId');
      if(fakeProgressTimer){clearInterval(fakeProgressTimer);fakeProgressTimer=null;}
      errorLoading(data.error||'Generation failed'); resetBtn();
    }
  } catch(err){ console.warn('[Poll]',err.message); }
}

async function generate(){
  try {
    const promptText=document.getElementById('prompt').value.trim();
    const negPrompt=document.getElementById('neg').value.trim();
    if(!promptText){ document.getElementById('prompt').focus(); return; }
    const [imgW,imgH]=getDims();
    const btn=document.getElementById('genBtn'); btn.disabled=true; btn.innerHTML='<span class="shim"></span>Generating‚Ä¶';
    addLoadingBatch(promptText,imgW,imgH);
    const payload={prompt:promptText,width:imgW,height:imgH};
    if(negPrompt) payload.negative_prompt=negPrompt;
    const res=await fetch(`${API_URL}/generate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error('Server error '+res.status);
    const data=await res.json();
    if(data.error) throw new Error(data.error);
    if(!data.jobId) throw new Error('No job ID received from server');
    localStorage.setItem('breezyfy_jobId',data.jobId); localStorage.setItem('breezyfy_prompt',promptText); localStorage.setItem('breezyfy_w',imgW); localStorage.setItem('breezyfy_h',imgH);
    const pos=data.position||1, secs=data.estimatedSeconds||0, ts=secs>=60?Math.ceil(secs/60)+' min':secs+' sec';
    updateLoadingMsg(pos===1?"You're next!":pos+' ahead in queue',pos===1?'almost your turn':'~'+ts+' estimated',pos);
    stopPolling(); const jobId=data.jobId; pollTimer=setInterval(()=>pollJobStatus(jobId),2000);
  } catch(err){
    stopPolling(); console.error('[Generate]',err.message);
    errorLoading((err.message.includes('fetch')||err.message.includes('Failed'))?'Unable to connect to server. Please try again.':(err.message||'Generation failed'));
    resetBtn();
  }
}

document.getElementById('prompt').addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') generate(); });
aspectRatio=parseFloat(document.getElementById('dimW').value)/parseFloat(document.getElementById('dimH').value);

/* ‚ïê‚ïê RESTORE IMAGES ‚ïê‚ïê */
(function restoreSavedImages(){
  try {
    const saved=localStorage.getItem('breezyfy_images'); if(!saved) return;
    const images=JSON.parse(saved); if(!images||!images.length) return;
    showFeed();
    [...images].reverse().forEach(item=>{
      const feed=document.getElementById('feedScroll');
      const batch=document.createElement('div'); batch.className='batch';
      const bh=document.createElement('div'); bh.className='bh';
      bh.innerHTML=`<svg class="bh-img-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><div class="bh-divider"></div><div class="bh-badge hi">Breezyfy</div><div class="bh-badge">${item.imgW} √ó ${item.imgH}</div><div class="bh-actions">${buildBhDl(item.src,item.imgW,item.imgH)}</div>`;
      const imgArea=document.createElement('div'); imgArea.className='batch-img-area';
      const row=document.createElement('div'); row.className='batch-img-row';
      const imgCol=document.createElement('div'); imgCol.className='batch-img-col';
      const adCol=document.createElement('div'); adCol.className='batch-ad-col';

      const outer=document.createElement('div'); outer.className='result-img-outer';
      const imgWrap=document.createElement('div'); imgWrap.className='result-img-wrap'; imgWrap.style.aspectRatio=item.imgW+'/'+item.imgH;
      const img=document.createElement('img'); img.src=item.src; img.style.opacity='1'; imgWrap.appendChild(img);
      if(!isMobile()) imgWrap.onclick=()=>openLightbox(item.src,'',item.imgW,item.imgH);
      const dlBar=document.createElement('div'); dlBar.className='img-dl-bar'; dlBar.innerHTML=buildDlBar(item.src,item.imgW,item.imgH);
      outer.appendChild(imgWrap); outer.appendChild(dlBar); imgCol.appendChild(outer);
      injectAd(adCol);
      row.appendChild(imgCol); row.appendChild(adCol);
      imgArea.appendChild(row); batch.appendChild(bh); batch.appendChild(imgArea); feed.insertBefore(batch,feed.firstChild);
    });
    images.forEach(item=>recentSrcs.push(item)); renderRecent();
    const cb=document.getElementById('clearBtn'); if(cb) cb.style.display='flex';
  } catch(e){ console.warn('Restore:',e.message); }
})();

/* ‚ïê‚ïê RESUME PENDING JOB ‚ïê‚ïê */
(async function resumeIfPending(){
  const savedJobId=localStorage.getItem('breezyfy_jobId'); if(!savedJobId) return;
  const savedPrompt=localStorage.getItem('breezyfy_prompt')||'...';
  const savedW=parseInt(localStorage.getItem('breezyfy_w'))||512;
  const savedH=parseInt(localStorage.getItem('breezyfy_h'))||512;
  try {
    const res=await fetch(`${API_URL}/job/${savedJobId}`); if(!res.ok){localStorage.removeItem('breezyfy_jobId');return;}
    const data=await res.json();
    if(data.status==='done'){
      localStorage.removeItem('breezyfy_jobId'); addLoadingBatch(savedPrompt,savedW,savedH);
      updateLoadingMsg('Image ready!','was generated before refresh',0,100);
      setTimeout(()=>{ if(data.image) resolveLoading('data:image/png;base64,'+data.image); resetBtn(); },800);
    } else if(data.status==='queued'||data.status==='processing'){
      const btn=document.getElementById('genBtn'); btn.disabled=true; btn.innerHTML='<span class="shim"></span>Generating‚Ä¶';
      addLoadingBatch(savedPrompt,savedW,savedH);
      updateLoadingMsg('Resuming your session...','your job is still running',data.position||1);
      wasProcessing=false; stopPolling(); pollTimer=setInterval(()=>pollJobStatus(savedJobId),2000);
    } else { localStorage.removeItem('breezyfy_jobId'); }
  } catch(e){ localStorage.removeItem('breezyfy_jobId'); }
})();
</script>
</body>
</html>
