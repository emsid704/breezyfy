<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Breezyfy ‚Äî Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#05050d;--surf:#09091a;--card:#0d0d20;--card2:#111125;--bdr:rgba(255,255,255,.07);--acc:#6e50ff;--alit:#9b7dff;--wh:#ffffff;--txt:#d0d0e8;--sub:#7070a0;--mut:#383858;--ok:#00d97e;--warn:#f5a623;--err:#ff4757;--live:#00ff88}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Syne',sans-serif;overflow:hidden}
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.015'/%3E%3C/svg%3E");background-size:160px}

/* LOGIN */
#loginScreen{position:fixed;inset:0;z-index:999;display:flex;align-items:center;justify-content:center;background:var(--bg)}
.login-box{width:380px;background:var(--card);border:1px solid var(--bdr);border-radius:20px;padding:44px 40px;text-align:center;box-shadow:0 0 80px rgba(110,80,255,.08);position:relative;z-index:1}
.login-logo{font-size:28px;font-weight:800;color:var(--wh);margin-bottom:4px}
.login-logo span{color:var(--acc)}
.login-sub{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.15em;text-transform:uppercase;color:var(--sub);margin-bottom:32px}
.login-input{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:10px;color:var(--wh);font-family:'DM Mono',monospace;font-size:14px;padding:14px 16px;outline:none;transition:border-color .2s;margin-bottom:14px}
.login-input:focus{border-color:rgba(110,80,255,.5)}
.login-btn{width:100%;background:linear-gradient(135deg,var(--acc),#4a30c8);border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;letter-spacing:.06em;padding:14px;cursor:pointer;transition:opacity .2s}
.login-btn:hover{opacity:.88}
.login-err{font-family:'DM Mono',monospace;font-size:11px;color:var(--err);margin-top:10px;display:none}

/* LAYOUT */
#app{display:none;height:100%;flex-direction:row}
.sidebar{width:220px;flex-shrink:0;height:100%;background:var(--surf);border-right:1px solid var(--bdr);display:flex;flex-direction:column;position:relative;z-index:10}
.sb-logo{padding:22px 20px 18px;border-bottom:1px solid var(--bdr)}
.sb-logo-txt{font-size:20px;font-weight:800;color:var(--wh)}
.sb-logo-txt span{color:var(--acc)}
.sb-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--sub);letter-spacing:.18em;text-transform:uppercase;margin-bottom:3px}
.sb-tag{font-family:'DM Mono',monospace;font-size:9px;color:var(--mut);letter-spacing:.1em}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto}
.nav-section{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--mut);padding:14px 10px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .15s;font-size:13px;font-weight:600;color:var(--sub);position:relative}
.nav-item:hover{background:rgba(255,255,255,.04);color:var(--txt)}
.nav-item.active{background:rgba(110,80,255,.12);color:var(--alit)}
.nav-badge{position:absolute;right:10px;font-family:'DM Mono',monospace;font-size:10px;background:rgba(110,80,255,.2);color:var(--alit);padding:1px 7px;border-radius:5px}
.nav-badge.red{background:rgba(255,71,87,.2);color:var(--err)}
.sb-bottom{padding:14px 10px;border-top:1px solid var(--bdr)}
.status-row{display:flex;align-items:center;gap:8px;padding:8px 10px}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--err);flex-shrink:0;transition:background .3s}
.status-dot.online{background:var(--live);box-shadow:0 0 8px var(--live)}
.status-txt{font-family:'DM Mono',monospace;font-size:11px;color:var(--sub)}
.logout-btn{width:100%;font-family:'DM Mono',monospace;font-size:11px;color:var(--mut);background:transparent;border:1px solid var(--bdr);border-radius:8px;padding:8px;cursor:pointer;transition:all .2s;margin-top:8px}
.logout-btn:hover{border-color:rgba(255,71,87,.3);color:var(--err)}

/* MAIN AREA */
.main{flex:1;height:100%;overflow-y:auto;display:flex;flex-direction:column;position:relative;z-index:5}
.main::-webkit-scrollbar{width:5px}
.main::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
.topbar{height:56px;flex-shrink:0;display:flex;align-items:center;padding:0 28px;gap:16px;border-bottom:1px solid var(--bdr);background:rgba(5,5,13,.8);backdrop-filter:blur(16px);position:sticky;top:0;z-index:20}
.topbar-title{font-size:16px;font-weight:700;color:var(--wh)}
.topbar-sub{font-family:'DM Mono',monospace;font-size:11px;color:var(--sub)}
.topbar-spacer{flex:1}
.refresh-txt{font-family:'DM Mono',monospace;font-size:10px;color:var(--mut)}

/* PAGES */
.page-section{display:none;padding:28px;flex-direction:column;gap:24px}
.page-section.active{display:flex}

/* STAT CARDS */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.stat-card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:20px 22px;display:flex;flex-direction:column;gap:8px;transition:border-color .2s}
.stat-card:hover{border-color:rgba(110,80,255,.2)}
.stat-ico{font-size:20px;opacity:.7}
.stat-val{font-family:'DM Mono',monospace;font-size:32px;font-weight:400;color:var(--wh);letter-spacing:-.02em}
.stat-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--sub)}
.stat-card.s-live .stat-val{color:var(--live)}

/* CHART */
.chart-card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:22px 24px}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.chart-title{font-size:13px;font-weight:700;color:var(--wh)}
.chart-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--sub)}
.chart-bars{display:flex;align-items:flex-end;gap:4px;height:80px}
.chart-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%}
.chart-bar{width:100%;background:rgba(110,80,255,.25);border-radius:3px 3px 0 0;min-height:2px;transition:height .4s ease}
.chart-bar.active{background:rgba(110,80,255,.7)}
.chart-lbl{font-family:'DM Mono',monospace;font-size:8px;color:var(--mut)}

/* TABLE */
.table-card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;overflow:hidden}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--bdr)}
.table-title{font-size:13px;font-weight:700;color:var(--wh)}
.table-total{font-family:'DM Mono',monospace;font-size:10px;color:var(--sub)}
.search-box{background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:8px;color:var(--txt);font-family:'DM Mono',monospace;font-size:12px;padding:7px 12px;outline:none;transition:border-color .2s;width:220px}
.search-box:focus{border-color:rgba(110,80,255,.4)}
table{width:100%;border-collapse:collapse}
th{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--sub);padding:10px 20px;text-align:left;border-bottom:1px solid var(--bdr);background:rgba(255,255,255,.02)}
td{font-family:'DM Mono',monospace;font-size:12px;color:var(--txt);padding:10px 20px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.ip-cell{color:var(--alit);font-weight:500}
.tag{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;padding:2px 9px;border-radius:5px}
.tag.ok{background:rgba(0,217,126,.1);color:var(--ok)}
.tag.err{background:rgba(255,71,87,.1);color:var(--err)}
.tag.warn{background:rgba(245,166,35,.1);color:var(--warn)}
.tag.live{background:rgba(0,255,136,.08);color:var(--live)}
.action-btn{font-family:'DM Mono',monospace;font-size:10px;padding:4px 12px;border-radius:6px;cursor:pointer;border:1px solid;transition:all .18s}
.action-btn.block{border-color:rgba(255,71,87,.3);color:var(--err);background:rgba(255,71,87,.06)}
.action-btn.block:hover{background:rgba(255,71,87,.2)}
.action-btn.unblock{border-color:rgba(0,217,126,.3);color:var(--ok);background:rgba(0,217,126,.06)}
.action-btn.unblock:hover{background:rgba(0,217,126,.2)}

/* SYSTEM */
.sys-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.sys-card{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:18px 20px}
.sys-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--sub);margin-bottom:8px}
.sys-val{font-family:'DM Mono',monospace;font-size:18px;color:var(--wh)}

/* ‚ïê‚ïê‚ïê TEMPLATE SECTION ‚ïê‚ïê‚ïê */
.tpl-upload-card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:24px}
.tpl-upload-title{font-size:14px;font-weight:700;color:var(--wh);margin-bottom:18px}
.tpl-form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.tpl-field{display:flex;flex-direction:column;gap:6px}
.tpl-field.full{grid-column:1/-1}
.tpl-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--sub)}
.tpl-input{background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:9px;color:var(--wh);font-family:'DM Mono',monospace;font-size:13px;padding:11px 14px;outline:none;transition:border-color .2s;width:100%}
.tpl-input:focus{border-color:rgba(110,80,255,.5)}
.tpl-textarea{background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:9px;color:var(--wh);font-family:'DM Mono',monospace;font-size:13px;padding:11px 14px;outline:none;transition:border-color .2s;width:100%;resize:vertical;min-height:90px;line-height:1.7}
.tpl-textarea:focus{border-color:rgba(110,80,255,.5)}
.tpl-img-drop{border:2px dashed rgba(110,80,255,.25);border-radius:12px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.tpl-img-drop:hover,.tpl-img-drop.over{border-color:rgba(110,80,255,.6);background:rgba(110,80,255,.06)}
.tpl-img-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.tpl-drop-txt{font-family:'DM Mono',monospace;font-size:12px;color:var(--sub)}
.tpl-drop-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--mut);margin-top:4px}
.tpl-preview{width:100%;max-height:160px;object-fit:contain;border-radius:8px;margin-top:10px;display:none}
.tpl-save-btn{background:linear-gradient(135deg,var(--acc),#4a30c8);border:none;border-radius:10px;color:#fff;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;letter-spacing:.06em;padding:13px 28px;cursor:pointer;transition:opacity .2s;align-self:flex-start}
.tpl-save-btn:hover{opacity:.85}
.tpl-save-btn:disabled{opacity:.4;cursor:not-allowed}
.tpl-msg{font-family:'DM Mono',monospace;font-size:11px;padding:8px 14px;border-radius:7px;display:none}
.tpl-msg.ok{background:rgba(0,217,126,.1);color:var(--ok);border:1px solid rgba(0,217,126,.2)}
.tpl-msg.err{background:rgba(255,71,87,.1);color:var(--err);border:1px solid rgba(255,71,87,.2)}

/* Template grid */
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
.tpl-item{background:var(--card2);border:1px solid var(--bdr);border-radius:12px;overflow:hidden;position:relative;transition:border-color .2s}
.tpl-item:hover{border-color:rgba(110,80,255,.3)}
.tpl-item img{width:100%;aspect-ratio:1;object-fit:cover;display:block}
.tpl-item-info{padding:10px 12px}
.tpl-item-title{font-size:12px;font-weight:600;color:var(--wh);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}
.tpl-item-prompt{font-family:'DM Mono',monospace;font-size:10px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tpl-del-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:6px;background:rgba(255,71,87,.8);border:none;color:#fff;font-size:14px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:background .18s}
.tpl-item:hover .tpl-del-btn{display:flex}
.tpl-del-btn:hover{background:var(--err)}
.empty-tpl{font-family:'DM Mono',monospace;font-size:12px;color:var(--sub);text-align:center;padding:40px;background:var(--card);border-radius:14px}

/* API URL setting */
.setting-card{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:20px 22px;display:flex;align-items:center;gap:14px}
.setting-lbl{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--sub);white-space:nowrap}
.setting-input{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:8px;color:var(--wh);font-family:'DM Mono',monospace;font-size:12px;padding:9px 13px;outline:none;transition:border-color .2s}
.setting-input:focus{border-color:rgba(110,80,255,.5)}
.setting-save{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.06em;background:rgba(110,80,255,.15);border:1px solid rgba(110,80,255,.3);color:var(--alit);border-radius:8px;padding:9px 18px;cursor:pointer;transition:all .18s;white-space:nowrap}
.setting-save:hover{background:rgba(110,80,255,.3)}

/* BLOCK MODAL */
.modal-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:var(--card);border:1px solid rgba(110,80,255,.2);border-radius:16px;padding:32px;width:380px}
.modal-title{font-size:16px;font-weight:700;color:var(--wh);margin-bottom:6px}
.modal-sub{font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);margin-bottom:20px}
.modal-input{width:100%;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:9px;color:var(--wh);font-family:'DM Mono',monospace;font-size:13px;padding:12px 14px;outline:none;margin-bottom:16px;transition:border-color .2s}
.modal-input:focus{border-color:rgba(110,80,255,.5)}
.modal-btns{display:flex;gap:10px}
.modal-btn{flex:1;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;letter-spacing:.05em;border-radius:9px;padding:11px;cursor:pointer;transition:all .18s;border:1px solid}
.modal-btn.cancel{background:transparent;border-color:var(--bdr);color:var(--sub)}
.modal-btn.cancel:hover{border-color:rgba(255,255,255,.2);color:var(--txt)}
.modal-btn.confirm{background:rgba(255,71,87,.15);border-color:rgba(255,71,87,.4);color:var(--err)}
.modal-btn.confirm:hover{background:rgba(255,71,87,.3)}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--card2);border:1px solid var(--bdr);border-radius:10px;padding:12px 20px;font-family:'DM Mono',monospace;font-size:12px;color:var(--txt);z-index:999;opacity:0;transform:translateY(10px);transition:all .3s ease;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}
.toast.ok{border-color:rgba(0,217,126,.3);color:var(--ok)}
.toast.err{border-color:rgba(255,71,87,.3);color:var(--err)}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo"><span>B</span>reezyfy</div>
    <div class="login-sub">Admin Panel</div>
    <input class="login-input" type="password" id="passInput" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/>
    <button class="login-btn" onclick="doLogin()">Login</button>
    <div class="login-err" id="loginErr">Wrong password</div>
  </div>
</div>

<!-- BLOCK MODAL -->
<div class="modal-overlay" id="blockModal">
  <div class="modal-box">
    <div class="modal-title">Block IP</div>
    <div class="modal-sub" id="blockModalIp">‚Äî</div>
    <input class="modal-input" type="text" id="blockReason" placeholder="Reason (optional)" value="Admin action"/>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="closeBlockModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmBlock()">Block IP</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- APP -->
<div id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-txt"><span>B</span>reezyfy</div>
      <div class="sb-tag">Admin Panel</div>
    </div>
    <div class="sb-nav">
      <div class="nav-section">Dashboard</div>
      <div class="nav-item active" onclick="showPage('overview',this)">üìä Overview</div>
      <div class="nav-section">Monitoring</div>
      <div class="nav-item" onclick="showPage('users',this)">üë• Live Users <span class="nav-badge" id="badge-users">0</span></div>
      <div class="nav-item" onclick="showPage('logs',this)">üñº Image Logs</div>
      <div class="nav-section">Content</div>
      <div class="nav-item" onclick="showPage('templates',this)">‚ú® Templates <span class="nav-badge" id="badge-tpl">0</span></div>
      <div class="nav-section">Security</div>
      <div class="nav-item" onclick="showPage('blocked',this)">üö´ Blocked IPs <span class="nav-badge red" id="badge-blocked">0</span></div>
      <div class="nav-section">Server</div>
      <div class="nav-item" onclick="showPage('system',this)">‚öôÔ∏è System Status</div>
    </div>
    <div class="sb-bottom">
      <div class="status-row">
        <div class="status-dot" id="statusDot"></div>
        <div class="status-txt" id="statusTxt">Offline</div>
      </div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--mut);padding:0 10px 6px" id="lastRefresh"></div>
      <button class="logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div>
        <div class="topbar-title" id="pageTitle">Overview</div>
        <div class="topbar-sub" id="pageDesc">Real-time analytics</div>
      </div>
      <div class="topbar-spacer"></div>
      <div class="refresh-txt" id="refreshTxt"></div>
    </div>

    <!-- OVERVIEW -->
    <div class="page-section active" id="page-overview">
      <div class="stat-grid">
        <div class="stat-card s-live"><div class="stat-ico">üü¢</div><div class="stat-val" id="s-live">0</div><div class="stat-lbl">Live Users (5min)</div></div>
        <div class="stat-card"><div class="stat-ico">üë•</div><div class="stat-val" id="s-total">0</div><div class="stat-lbl">Total Unique IPs</div></div>
        <div class="stat-card"><div class="stat-ico">üñº</div><div class="stat-val" id="s-images">0</div><div class="stat-lbl">Images Generated</div></div>
        <div class="stat-card"><div class="stat-ico">üö´</div><div class="stat-val" id="s-blocked">0</div><div class="stat-lbl">Blocked IPs</div></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">Generations ‚Äî Last 24 Hours</div><div class="chart-sub">Hourly breakdown</div></div>
        </div>
        <div class="chart-bars" id="chartBars"></div>
      </div>
      <div class="table-card">
        <div class="table-header"><div class="table-title">Recent Generations</div><div class="table-total" id="logCount">‚Äî</div></div>
        <table><thead><tr><th>Time</th><th>IP Address</th><th>Prompt</th><th>Size</th><th>Status</th></tr></thead>
        <tbody id="overviewLogsBody"></tbody></table>
      </div>
    </div>

    <!-- USERS -->
    <div class="page-section" id="page-users">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">All Users</div>
          <span class="table-total" id="userTotal">‚Äî</span>
          <input class="search-box" type="text" id="userSearch" placeholder="Search IP..." oninput="renderUsers(this.value)"/>
        </div>
        <table><thead><tr><th>IP Address</th><th>Status</th><th>First Seen</th><th>Last Active</th><th>Images</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"></tbody></table>
      </div>
    </div>

    <!-- LOGS -->
    <div class="page-section" id="page-logs">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Image Logs</div>
          <span class="table-total" id="logsTotal">‚Äî</span>
          <input class="search-box" type="text" id="logSearch" placeholder="Search prompt/IP..." oninput="renderLogs(this.value)"/>
        </div>
        <table><thead><tr><th>Time</th><th>IP</th><th>Prompt</th><th>Size</th><th>Status</th></tr></thead>
        <tbody id="logsBody"></tbody></table>
      </div>
    </div>

    <!-- TEMPLATES -->
    <div class="page-section" id="page-templates">
      <!-- Upload form -->
      <div class="tpl-upload-card">
        <div class="tpl-upload-title">Upload New Template</div>
        <div class="tpl-form">
          <div class="tpl-field">
            <div class="tpl-label">Title</div>
            <input class="tpl-input" type="text" id="tplTitle" placeholder="e.g. Cyberpunk City"/>
          </div>
          <div class="tpl-field">
            <div class="tpl-label">Tags (comma separated)</div>
            <input class="tpl-input" type="text" id="tplTags" placeholder="e.g. fantasy, dark, portrait"/>
          </div>
          <div class="tpl-field full">
            <div class="tpl-label">Prompt</div>
            <textarea class="tpl-textarea" id="tplPrompt" placeholder="Write the prompt that was used to generate this image..."></textarea>
          </div>
          <div class="tpl-field full">
            <div class="tpl-label">Image</div>
            <div class="tpl-img-drop" id="tplDrop">
              <input type="file" accept="image/*" id="tplFile" onchange="handleTplFile(this)"/>
              <div class="tpl-drop-txt">üìÇ Click to choose image</div>
              <div class="tpl-drop-hint">PNG, JPG, WEBP ‚Äî max 5MB</div>
              <img id="tplPreview" class="tpl-preview" alt="preview"/>
            </div>
          </div>
          <div class="tpl-field full" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
            <button class="tpl-save-btn" id="tplSaveBtn" onclick="saveTemplate()">Upload Template</button>
            <div class="tpl-msg" id="tplMsg"></div>
          </div>
        </div>
      </div>

      <!-- Existing templates -->
      <div class="table-card" style="border-radius:14px">
        <div class="table-header">
          <div class="table-title">Uploaded Templates</div>
          <span class="table-total" id="tplCount">0 templates</span>
        </div>
        <div style="padding:16px" id="tplGridWrap">
          <div class="tpl-grid" id="tplGrid"></div>
          <div class="empty-tpl" id="tplEmpty" style="display:none">No templates yet ‚Äî upload your first one above!</div>
        </div>
      </div>
    </div>

    <!-- BLOCKED -->
    <div class="page-section" id="page-blocked">
      <div class="table-card">
        <div class="table-header"><div class="table-title">Blocked IPs</div><span class="table-total" id="blockedTotal">‚Äî</span></div>
        <table><thead><tr><th>IP Address</th><th>Blocked At</th><th>Reason</th><th>Actions</th></tr></thead>
        <tbody id="blockedBody"></tbody></table>
      </div>
    </div>

    <!-- SYSTEM -->
    <div class="page-section" id="page-system">
      <div class="setting-card">
        <span class="setting-lbl">API URL</span>
        <input class="setting-input" type="text" id="apiUrlInput" placeholder="https://your-tunnel.trycloudflare.com"/>
        <button class="setting-save" onclick="saveApiUrl()">Save & Reconnect</button>
      </div>
      <div class="setting-card" style="margin-top:14px">
        <span class="setting-lbl">Google Drive Sync (Apps Script URL)</span>
        <input class="setting-input" type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/.../exec"/>
        <button class="setting-save" onclick="saveGasUrl()">Save GAS URL</button>
        <div style="margin-top:8px;font-family:'DM Mono',monospace;font-size:10px;color:var(--sub);line-height:1.7">
          Google Apps Script se templates Google Drive mein store honge.<br>
          Setup guide: Admin panel ‚Üí System ‚Üí "GAS Setup Guide" button dekho.
        </div>
      </div>
      <div class="setting-card" style="margin-top:14px">
        <span class="setting-lbl">GAS Setup Guide</span>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--sub);line-height:2;margin-bottom:12px">
          1. <a href="https://script.google.com" target="_blank" style="color:var(--alit)">script.google.com</a> kholo ‚Üí New Project<br>
          2. Neeche diya code paste karo ‚Üí Save ‚Üí Deploy as Web App<br>
          3. "Execute as: Me", "Access: Anyone" select karo ‚Üí Deploy<br>
          4. Milne wala URL yahan paste karo
        </div>
        <div style="background:rgba(0,0,0,.4);border:1px solid var(--bdr);border-radius:8px;padding:12px;font-family:'DM Mono',monospace;font-size:10px;color:var(--ok);white-space:pre-wrap;max-height:200px;overflow-y:auto" id="gasScriptBox">function doGet(e){
  const action=e.parameter.action,id=e.parameter.id;
  const ss=SpreadsheetApp.getActiveOrOpenByUrl(PropertiesService.getScriptProperties().getProperty('SHEET_URL')||createSheet());
  const sh=ss.getSheets()[0];
  if(action==='list'){
    const rows=sh.getDataRange().getValues();
    const data=rows.slice(1).map(r=>({id:r[0],title:r[1],prompt:r[2],image:r[3],tags:r[4]?JSON.parse(r[4]):[],createdAt:r[5]})).filter(r=>r.id);
    return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
}
function doPost(e){
  const action=e.parameter.action;
  const body=JSON.parse(e.postData.contents||'{}');
  const ss=SpreadsheetApp.getActiveSpreadsheet();
  const sh=ss.getSheets()[0];
  if(action==='add'){sh.appendRow([body.id,body.title,body.prompt,body.image,JSON.stringify(body.tags||[]),body.createdAt]);}
  else if(action==='delete'){
    const rows=sh.getDataRange().getValues();
    for(let i=rows.length-1;i>=1;i--){if(rows[i][0]===body.id)sh.deleteRow(i+1);}
  }
  return ContentService.createTextOutput(JSON.stringify({ok:true})).setMimeType(ContentService.MimeType.JSON);
}
function createSheet(){const ss=SpreadsheetApp.create('Breezyfy Templates');ss.getSheets()[0].appendRow(['id','title','prompt','image','tags','createdAt']);PropertiesService.getScriptProperties().setProperty('SHEET_URL',ss.getUrl());return ss.getUrl();}</div>
        <button class="setting-save" style="margin-top:8px" onclick="copyGasScript()">Copy Script</button>
      </div>
      <div class="sys-grid">
        <div class="sys-card"><div class="sys-lbl">Node Version</div><div class="sys-val" id="sys-node">‚Äî</div></div>
        <div class="sys-card"><div class="sys-lbl">Platform</div><div class="sys-val" id="sys-platform">‚Äî</div></div>
        <div class="sys-card"><div class="sys-lbl">Uptime</div><div class="sys-val" id="sys-uptime">‚Äî</div></div>
        <div class="sys-card"><div class="sys-lbl">Memory Used</div><div class="sys-val" id="sys-mem">‚Äî</div></div>
        <div class="sys-card"><div class="sys-lbl">Users Tracked</div><div class="sys-val" id="sys-users">‚Äî</div></div>
        <div class="sys-card"><div class="sys-lbl">Logs Stored</div><div class="sys-val" id="sys-logs">‚Äî</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const ADMIN_PASS = 'breezyfy@admin2024';
let API_URL = localStorage.getItem('bzfy_api') || 'https://matt-discussing-opinions-week.trycloudflare.com';
let allUsers=[], allLogs=[], allBlocked=[], allTemplates=[];
let refreshTimer=null, blockTargetIp='';

// ‚îÄ‚îÄ LOGIN
function doLogin(){
  const v = document.getElementById('passInput').value;
  if(v === ADMIN_PASS){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('app').style.display='flex';
    document.getElementById('apiUrlInput').value = API_URL;
    init();
  } else {
    document.getElementById('loginErr').style.display='block';
    setTimeout(()=>document.getElementById('loginErr').style.display='none',2000);
  }
}
document.getElementById('passInput').addEventListener('keydown',e=>{ if(e.key==='Enter') doLogin(); });

function doLogout(){ location.reload(); }

// ‚îÄ‚îÄ NAV
const pageTitles = { overview:'Overview', users:'Live Users', logs:'Image Logs', templates:'Templates', blocked:'Blocked IPs', system:'System Status' };
const pageDescs  = { overview:'Real-time analytics', users:'All tracked IPs', logs:'Generation history', templates:'Manage gallery templates', blocked:'IP block list', system:'Server information' };
function showPage(id, el){
  document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(el) el.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[id]||id;
  document.getElementById('pageDesc').textContent  = pageDescs[id]||'';
  if(id==='templates') loadTemplatesPanel();
  if(id==='system') loadGasUrl();
}

// ‚îÄ‚îÄ API
async function apiFetch(path, opts={}){
  try {
    const res = await fetch(`${API_URL}/admin${path}`, {
      ...opts,
      headers:{ 'x-admin-token':ADMIN_PASS, 'Content-Type':'application/json', ...(opts.headers||{}) }
    });
    if(!res.ok) throw new Error(res.status);
    return await res.json();
  } catch(e){ return null; }
}

async function apiCall(path, opts={}){
  // For non-admin routes (like /templates)
  try {
    const res = await fetch(`${API_URL}${path}`, {
      ...opts,
      headers:{ 'x-admin-token':ADMIN_PASS, 'Content-Type':'application/json', ...(opts.headers||{}) }
    });
    if(!res.ok) throw new Error(res.status);
    return await res.json();
  } catch(e){ return null; }
}

// ‚îÄ‚îÄ FETCH ALL
async function fetchAll(){
  const [stats, users, logs, blocked, sys] = await Promise.all([
    apiFetch('/stats'), apiFetch('/users'), apiFetch('/logs?limit=200'), apiFetch('/blocked'), apiFetch('/system')
  ]);
  const online = stats !== null;
  document.getElementById('statusDot').className = 'status-dot' + (online?' online':'');
  document.getElementById('statusTxt').textContent = online ? 'Online' : 'Offline';
  document.getElementById('refreshTxt').textContent = 'Updated ' + new Date().toLocaleTimeString();

  if(stats){
    document.getElementById('s-live').textContent    = stats.liveUsers||0;
    document.getElementById('s-total').textContent   = stats.totalUsers||0;
    document.getElementById('s-images').textContent  = stats.totalImages||0;
    document.getElementById('s-blocked').textContent = stats.blockedCount||0;
    document.getElementById('logCount').textContent  = (stats.totalImages||0) + ' total';
    renderChart(stats.hourly||[]);
  }
  if(users){ allUsers=users; renderUsers(); updateUserBadge(users); }
  if(logs){  allLogs=logs;  renderLogs(); renderOverviewLogs(); }
  if(blocked){ allBlocked=blocked; renderBlocked(); document.getElementById('badge-blocked').textContent=blocked.length; }
  if(sys){
    document.getElementById('sys-node').textContent     = sys.node||'‚Äî';
    document.getElementById('sys-platform').textContent = sys.platform||'‚Äî';
    document.getElementById('sys-uptime').textContent   = fmtUptime(sys.uptime||0);
    document.getElementById('sys-mem').textContent      = (sys.memUsedMB||0)+' MB';
    document.getElementById('sys-users').textContent    = sys.usersTracked||0;
    document.getElementById('sys-logs').textContent     = sys.logsStored||0;
  }
}

function fmtUptime(s){ const h=Math.floor(s/3600),m=Math.floor((s%3600)/60); return `${h}h ${m}m`; }

// ‚îÄ‚îÄ CHART
function renderChart(hourly){
  const bars = document.getElementById('chartBars');
  const maxV = Math.max(1,...hourly);
  const curH = new Date().getHours();
  bars.innerHTML = hourly.map((v,h)=>`
    <div class="chart-bar-wrap">
      <div class="chart-bar${h===curH?' active':''}" style="height:${Math.max(4,Math.round((v/maxV)*100))}%" title="${v} images at ${h}:00"></div>
      <div class="chart-lbl">${h%6===0?h:''}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ USERS
function updateUserBadge(users){
  const now=Date.now(), live=users.filter(u=>now-u.lastSeen<5*60*1000).length;
  document.getElementById('badge-users').textContent=live;
}
function renderUsers(filter=''){
  const now=Date.now();
  let list=allUsers;
  if(filter) list=list.filter(u=>u.ip.includes(filter));
  document.getElementById('userTotal').textContent=list.length+' users';
  document.getElementById('usersBody').innerHTML = list.map(u=>{
    const live=!u.blocked&&now-u.lastSeen<5*60*1000;
    const idle=!u.blocked&&!live;
    return `<tr>
      <td class="ip-cell">${u.ip}</td>
      <td>${u.blocked?'<span class="tag err">Blocked</span>':live?'<span class="tag live">Live</span>':'<span class="tag warn">Idle</span>'}</td>
      <td>${fmtTime(u.firstSeen)}</td>
      <td>${fmtTime(u.lastSeen)}</td>
      <td>${u.count||0} (‚úì${u.success||0} ‚úó${u.fail||0})</td>
      <td>${u.blocked
        ?`<button class="action-btn unblock" onclick="doUnblock('${u.ip}')">Unblock</button>`
        :`<button class="action-btn block" onclick="openBlockModal('${u.ip}')">Block</button>`
      }</td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--sub);padding:30px">No users yet</td></tr>';
}

// ‚îÄ‚îÄ LOGS
function renderLogs(filter=''){
  let list=allLogs;
  if(filter) list=list.filter(l=>l.ip.includes(filter)||l.prompt.toLowerCase().includes(filter.toLowerCase()));
  document.getElementById('logsTotal').textContent=list.length+' logs';
  document.getElementById('logsBody').innerHTML = list.slice(0,200).map(l=>`<tr>
    <td>${fmtTime(l.ts)}</td>
    <td class="ip-cell">${l.ip}</td>
    <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.prompt}</td>
    <td>${l.width}√ó${l.height}</td>
    <td>${l.success?'<span class="tag ok">Success</span>':'<span class="tag err">Failed</span>'}</td>
  </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--sub);padding:30px">No logs yet</td></tr>';
}

function renderOverviewLogs(){
  document.getElementById('overviewLogsBody').innerHTML = allLogs.slice(0,10).map(l=>`<tr>
    <td>${fmtTime(l.ts)}</td>
    <td class="ip-cell">${l.ip}</td>
    <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.prompt}</td>
    <td>${l.width}√ó${l.height}</td>
    <td>${l.success?'<span class="tag ok">‚úì</span>':'<span class="tag err">‚úó</span>'}</td>
  </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--sub);padding:24px">No logs yet</td></tr>';
}

// ‚îÄ‚îÄ BLOCKED
function renderBlocked(){
  document.getElementById('blockedTotal').textContent=allBlocked.length+' IPs';
  document.getElementById('blockedBody').innerHTML = allBlocked.map(b=>`<tr>
    <td class="ip-cell">${b.ip}</td>
    <td>${fmtTime(b.at)}</td>
    <td>${b.reason||'‚Äî'}</td>
    <td><button class="action-btn unblock" onclick="doUnblock('${b.ip}')">Unblock</button></td>
  </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--sub);padding:30px">No blocked IPs</td></tr>';
}

// ‚îÄ‚îÄ BLOCK / UNBLOCK
function openBlockModal(ip){ blockTargetIp=ip; document.getElementById('blockModalIp').textContent='Block: '+ip; document.getElementById('blockModal').classList.add('open'); }
function closeBlockModal(){ document.getElementById('blockModal').classList.remove('open'); blockTargetIp=''; }
async function confirmBlock(){
  const reason=document.getElementById('blockReason').value||'Admin action';
  const r=await apiFetch('/block',{method:'POST',body:JSON.stringify({ip:blockTargetIp,reason})});
  closeBlockModal();
  if(r&&r.success){ showToast('Blocked '+blockTargetIp,'ok'); fetchAll(); }
  else showToast('Block failed','err');
}
async function doUnblock(ip){
  const r=await apiFetch('/unblock',{method:'POST',body:JSON.stringify({ip})});
  if(r&&r.success){ showToast('Unblocked '+ip,'ok'); fetchAll(); }
  else showToast('Unblock failed','err');
}

// ‚îÄ‚îÄ TEMPLATES
let tplImageData = '';

function handleTplFile(input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ showToast('Image too large (max 5MB)','err'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    tplImageData = e.target.result;
    const prev = document.getElementById('tplPreview');
    prev.src = tplImageData;
    prev.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

async function saveTemplate(){
  const title  = document.getElementById('tplTitle').value.trim();
  const prompt = document.getElementById('tplPrompt').value.trim();
  const tags   = document.getElementById('tplTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const msg    = document.getElementById('tplMsg');
  const btn    = document.getElementById('tplSaveBtn');

  if(!prompt){ showTplMsg('Prompt is required!','err'); return; }
  if(!tplImageData){ showTplMsg('Please select an image!','err'); return; }

  btn.disabled = true; btn.textContent = 'Uploading...';
  const r = await apiCall('/templates',{ method:'POST', body:JSON.stringify({ title:title||'Untitled', prompt, image:tplImageData, tags }) });
  btn.disabled = false; btn.textContent = 'Upload Template';

  if(r&&r.success){
    showTplMsg('Template uploaded!','ok');
    showToast('Template added ‚úì','ok');
    document.getElementById('tplTitle').value='';
    document.getElementById('tplPrompt').value='';
    document.getElementById('tplTags').value='';
    document.getElementById('tplFile').value='';
    document.getElementById('tplPreview').style.display='none';
    tplImageData='';
    loadTemplatesPanel();
  } else {
    showTplMsg('Upload failed. Check API URL.','err');
  }
}

function showTplMsg(text, type){
  const el = document.getElementById('tplMsg');
  el.textContent = text;
  el.className = 'tpl-msg '+type;
  el.style.display = 'block';
  setTimeout(()=>el.style.display='none', 3000);
}

async function loadTemplatesPanel(){
  const data = await apiCall('/templates');
  allTemplates = data || [];
  document.getElementById('badge-tpl').textContent = allTemplates.length;
  document.getElementById('tplCount').textContent  = allTemplates.length+' templates';
  const grid  = document.getElementById('tplGrid');
  const empty = document.getElementById('tplEmpty');
  if(!allTemplates.length){ grid.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = allTemplates.map(t=>`
    <div class="tpl-item" id="tplitem_${t.id}">
      <img src="${t.image}" alt="${t.title}" loading="lazy"/>
      <div class="tpl-item-info">
        <div class="tpl-item-title">${t.title}</div>
        <div class="tpl-item-prompt">${t.prompt}</div>
      </div>
      <button class="tpl-del-btn" onclick="deleteTemplate('${t.id}')" title="Delete">‚úï</button>
    </div>`).join('');
}

async function deleteTemplate(id){
  if(!confirm('Delete this template?')) return;
  const r = await fetch(`${API_URL}/templates/${id}`,{ method:'DELETE', headers:{'x-admin-token':ADMIN_PASS} });
  if(r.ok){ showToast('Template deleted','ok'); loadTemplatesPanel(); }
  else showToast('Delete failed','err');
}

// ‚îÄ‚îÄ GAS / DRIVE
async function saveGasUrl(){
  const val = document.getElementById('gasUrlInput').value.trim();
  const r = await apiFetch('/settings', { method:'POST', body: JSON.stringify({ gasUrl: val }) });
  if(r && r.success) showToast('Google Drive URL saved!', 'ok');
  else showToast('Save failed', 'err');
}
function copyGasScript(){
  const txt = document.getElementById('gasScriptBox').textContent;
  navigator.clipboard.writeText(txt).then(()=>showToast('Script copied!','ok'));
}
async function loadGasUrl(){
  const r = await apiFetch('/settings');
  if(r && r.gasUrl) document.getElementById('gasUrlInput').value = r.gasUrl;
}

// ‚îÄ‚îÄ SETTINGS
function saveApiUrl(){
  const val = document.getElementById('apiUrlInput').value.trim();
  if(!val) return;
  API_URL = val;
  localStorage.setItem('bzfy_api', val);
  showToast('API URL saved. Reconnecting...','ok');
  clearInterval(refreshTimer);
  fetchAll().then(()=>{ refreshTimer=setInterval(fetchAll,6000); });
}

// ‚îÄ‚îÄ HELPERS
function fmtTime(ts){
  if(!ts) return '‚Äî';
  const d=new Date(ts);
  return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' '+d.toLocaleDateString([],{month:'short',day:'numeric'});
}

function showToast(msg, type=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+(type||'');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// ‚îÄ‚îÄ INIT
function init(){
  fetchAll();
  refreshTimer = setInterval(fetchAll, 6000);
}
</script>
</body>
</html>
